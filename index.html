<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω–æ–µ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: AI-–¢—Ä–µ–Ω–µ—Ä</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4f46e5;
            --primary-light: #818cf8;
            --background-color: #f8fafc;
            --success-color: #10b981; /* Tailwind green-500 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            transition: background-color 0.3s;
        }
        .app-container {
            max-width: 900px;
            margin: auto;
            min-height: 100vh;
        }
        /* Custom scrollbar for chat */
        .chat-box::-webkit-scrollbar {
            width: 6px;
        }
        .chat-box::-webkit-scrollbar-thumb {
            background-color: var(--primary-light);
            border-radius: 10px;
        }
        .chat-box::-webkit-scrollbar-track {
            background: #e0e7ff;
        }
        .nav-link.active {
            background-color: var(--primary-light);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        /* Simple spinner */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Make table sticky and handle overflow for 21 days */
        .habit-table th, .habit-table td {
            padding: 0.75rem 0.5rem; /* Reduced padding for more columns */
            text-align: center;
            white-space: nowrap;
        }
        .habit-table thead th:first-child, .habit-table tbody td:first-child {
            position: sticky;
            left: 0;
            background-color: #f8fafc; /* Use body background for continuity */
            z-index: 10;
        }
        .habit-table thead th:first-child {
            background-color: #eef2ff; /* Light indigo for header */
        }
        .habit-table-container {
            max-width: 100%;
            overflow-x: auto;
        }
        /* Chart specific styling */
        .chart-bar {
            width: 30px; /* Fixed width for bars */
            margin: 0 4px;
            background-color: var(--primary-color);
            transition: height 0.5s ease-out, background-color 0.3s ease; /* Added background transition */
            border-radius: 4px 4px 0 0;
        }
        .chart-bar.all-completed {
            background-color: var(--success-color); /* Highlight color */
            box-shadow: 0 0 10px var(--success-color);
        }
    </style>
    <script type="module">
        // Firebase Imports (Global variables are provided by the environment)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- CONFIGURATION ---
        setLogLevel('Debug');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const GEMINI_MODEL = 'gemini-2.5-flash-preview-05-20';
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent`;
        const API_KEY = ""; // Provided by the environment

        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let isLoading = false; // For API loading indicator
        
        // --- CONSTANTS ---
        const HABIT_DAYS = 21; // –î–ª—è —Ç—Ä–µ–∫–µ—Ä–∞ –ø—Ä–∏–≤—ã—á–µ–∫
        const SLEEP_DAYS = 28; // –î–ª—è 28-–¥–Ω–µ–≤–Ω–æ–≥–æ –ø–ª–∞–Ω–∞ —Å–Ω–∞

        // --- STATE STRUCTURE ---
        let state = {
            currentView: 'home',
            selectedCoach: 'Aurora', 
            coreTasks: [], 
            personalizedTasks: [],
            taskArchive: [], 
            tasks: [], 
            challenges: [],
            sleepPlan: [],
            dailyHabits: [], 
            progress: { totalTasks: 0, completedTasks: 0 },
            coachChat: [],
            
            isPersonalized: false, 
            testResults: null, 
            testAnswers: {},
            bonusPoints: 0, // NEW: –ë–æ–Ω—É—Å–Ω—ã–µ –æ—á–∫–∏ –∑–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ —Å–Ω–∞
        };

        // --- APP DATA ---
        const COACHES = {
            Aurora: { name: '–ê–≤—Ä–æ—Ä–∞', emoji: 'üíñ', style: '–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∞—è –ü–æ–¥—Ä—É–≥–∞' },
            Johnny: { name: '–î–∂–æ–Ω–∏', emoji: 'üí™', style: '–°—Ç—Ä–æ–≥–∏–π –¢—Ä–µ–Ω–µ—Ä' },
            Silas: { name: '–°–∞–π–ª–∞—Å', emoji: 'ü¶â', style: '–ú—É–¥—Ä—ã–π –§–∏–ª–æ—Å–æ—Ñ' }
        };

        // 21-day progress array (0 is today, 20 is the oldest day)
        const INITIAL_HABITS = [
            // progress array stores 21 days
            { id: 'h1', name: '–°–æ–Ω', target: '8 —á–∞—Å–æ–≤', progress: Array(HABIT_DAYS).fill(0), desc: '–°–ø–∏—Ç–µ –Ω–µ –º–µ–Ω–µ–µ 8 –ø–æ–ª–Ω—ã—Ö —á–∞—Å–æ–≤.' },
            { id: 'h2', name: '–°–ø–æ—Ä—Ç', target: '30 –º–∏–Ω', progress: Array(HABIT_DAYS).fill(0), desc: '–í—ã–ø–æ–ª–Ω—è–π—Ç–µ –ª—é–±—É—é —Ñ–∏–∑–∏—á–µ—Å–∫—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å 30 –º–∏–Ω—É—Ç.' },
            { id: 'h3', name: '–ß—Ç–µ–Ω–∏–µ', target: '10 —Å—Ç—Ä–∞–Ω–∏—Ü', progress: Array(HABIT_DAYS).fill(0), desc: '–ß–∏—Ç–∞–π—Ç–µ –ª—é–±—É—é –∫–Ω–∏–≥—É –∏–ª–∏ —Å—Ç–∞—Ç—å—é.' },
            { id: 'h4', name: '–Ø–∑—ã–∫', target: '20 –º–∏–Ω', progress: Array(HABIT_DAYS).fill(0), desc: '–£—á–∏—Ç–µ –Ω–æ–≤—ã–π —è–∑—ã–∫ –∏–ª–∏ –ø–æ–≤—Ç–æ—Ä—è–π—Ç–µ –ø—Ä–æ–π–¥–µ–Ω–Ω–æ–µ.' }
        ];

        const NEW_SLEEP_PLAN = [
            { day: 1, recommendation: '–ó–∞–≤–µ–¥–∏ ¬´–û–∫–Ω–æ –°–Ω–∞¬ª', explanation: '–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π —Ä–µ–∂–∏–º —Å–Ω–∞ —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä—É–µ—Ç –≤—ã—Ä–∞–±–æ—Ç–∫—É –≥–æ—Ä–º–æ–Ω–æ–≤ –º–µ–ª–∞—Ç–æ–Ω–∏–Ω–∞ –∏ –∫–æ—Ä—Ç–∏–∑–æ–ª–∞. –í—ã–±–µ—Ä–∏ –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ –≤—Ä–µ–º—è –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è –∏ –∑–∞—Å—ã–ø–∞–Ω–∏—è, –¥–∞–∂–µ –Ω–∞ –≤—ã—Ö–æ–¥–Ω—ã—Ö.', bonusPoints: 10, completed: false },
            { day: 2, recommendation: '–û–≥—Ä–∞–Ω–∏—á—å –ö–æ—Ñ–µ–∏–Ω –ø–æ—Å–ª–µ 14:00', explanation: '–ö–æ—Ñ–µ–∏–Ω –∏–º–µ–µ—Ç –ø–µ—Ä–∏–æ–¥ –ø–æ–ª—É—Ä–∞—Å–ø–∞–¥–∞ –¥–æ 6 —á–∞—Å–æ–≤. –ï–≥–æ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –≤–æ –≤—Ç–æ—Ä–æ–π –ø–æ–ª–æ–≤–∏–Ω–µ –¥–Ω—è –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Ä–µ—Ü–µ–ø—Ç–æ—Ä—ã –∞–¥–µ–Ω–æ–∑–∏–Ω–∞, —É—Ö—É–¥—à–∞—è –∫–∞—á–µ—Å—Ç–≤–æ –≥–ª—É–±–æ–∫–æ–≥–æ —Å–Ω–∞.', bonusPoints: 10, completed: false },
            { day: 3, recommendation: '–£—Å—Ç–∞–Ω–æ–≤–∏ ¬´–¶–∏—Ñ—Ä–æ–≤–æ–π –ö–æ–º–µ–Ω–¥–∞–Ω—Ç—Å–∫–∏–π –ß–∞—Å¬ª', explanation: '–ó–∞ —á–∞—Å –¥–æ —Å–Ω–∞ –æ—Ç–∫–∞–∂–∏—Å—å –æ—Ç –≤—Å–µ—Ö —ç–∫—Ä–∞–Ω–æ–≤ (—Ç–µ–ª–µ–≤–∏–∑–æ—Ä, —Ç–µ–ª–µ—Ñ–æ–Ω, –ø–ª–∞–Ω—à–µ—Ç). –°–∏–Ω–∏–π —Å–≤–µ—Ç –ø–æ–¥–∞–≤–ª—è–µ—Ç –≤—ã—Ä–∞–±–æ—Ç–∫—É –º–µ–ª–∞—Ç–æ–Ω–∏–Ω–∞.', bonusPoints: 10, completed: false },
            { day: 4, recommendation: '–°–æ–∑–¥–∞–π –í–µ—á–µ—Ä–Ω–∏–π –†–∏—Ç—É–∞–ª', explanation: '–ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è, —É—Å–ø–æ–∫–∞–∏–≤–∞—é—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è (—á—Ç–µ–Ω–∏–µ, –º–µ–¥–∏—Ç–∞—Ü–∏—è, —Ç–µ–ø–ª–∞—è –≤–∞–Ω–Ω–∞) —Å–∏–≥–Ω–∞–ª–∏–∑–∏—Ä—É—é—Ç –º–æ–∑–≥—É, —á—Ç–æ –ø–æ—Ä–∞ —Å–ø–∞—Ç—å, —É–ª—É—á—à–∞—è –∑–∞—Å—ã–ø–∞–Ω–∏–µ.', bonusPoints: 15, completed: false },
            { day: 5, recommendation: '–ü—Ä–æ–≤–µ—Ç—Ä–∏ –ö–æ–º–Ω–∞—Ç—É', explanation: '–ò–¥–µ–∞–ª—å–Ω–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è —Å–Ω–∞ ‚Äî –æ—Ç 18 –¥–æ 20¬∞C. –ü—Ä–æ—Ö–ª–∞–¥–Ω–æ–µ –ø–æ–º–µ—â–µ–Ω–∏–µ –ø–æ–º–æ–≥–∞–µ—Ç —Å–Ω–∏–∑–∏—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É —Ç–µ–ª–∞, —á—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –∑–∞—Å—ã–ø–∞–Ω–∏—è.', bonusPoints: 10, completed: false },
            { day: 6, recommendation: '–õ–µ–≥–∫–∏–π –ü–µ—Ä–µ–∫—É—Å', explanation: '–ò–∑–±–µ–≥–∞–π —Ç—è–∂–µ–ª–æ–π, –∂–∏—Ä–Ω–æ–π –∏–ª–∏ –æ—Å—Ç—Ä–æ–π –ø–∏—â–∏ –∑–∞ 2-3 —á–∞—Å–∞ –¥–æ —Å–Ω–∞. –ï—Å–ª–∏ –≥–æ–ª–æ–¥–µ–Ω, —Å—ä–µ—à—å –±–∞–Ω–∞–Ω –∏–ª–∏ –≥–æ—Ä—Å—Ç—å –æ—Ä–µ—Ö–æ–≤.', bonusPoints: 10, completed: false },
            { day: 7, recommendation: '–û—Å–≤–æ–π ¬´–¢–µ–ª–æ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ¬ª', explanation: '–¢–µ—Ö–Ω–∏–∫–∞ –º–µ–¥–∏—Ç–∞—Ü–∏–∏, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –Ω–∞ —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–∏–µ –∫–∞–∂–¥–æ–π —á–∞—Å—Ç–∏ —Ç–µ–ª–∞ –ø–æ –æ—á–µ—Ä–µ–¥–∏. –ü–æ–º–æ–≥–∞–µ—Ç —Å–Ω—è—Ç—å –º—ã—à–µ—á–Ω–æ–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ –∏ —É—Å–ø–æ–∫–æ–∏—Ç—å —É–º.', bonusPoints: 20, completed: false },
            { day: 8, recommendation: '–£–±–µ—Ä–∏ –ß–∞—Å—ã', explanation: '–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π –≤–∑–≥–ª—è–¥ –Ω–∞ –≤—Ä–µ–º—è –Ω–æ—á—å—é –≤—ã–∑—ã–≤–∞–µ—Ç —Ç—Ä–µ–≤–æ–≥—É. –ü–µ—Ä–µ–≤–µ—Ä–Ω–∏ —Ü–∏—Ñ–µ—Ä–±–ª–∞—Ç –∏–ª–∏ —É–±–µ—Ä–∏ —á–∞—Å—ã –ø–æ–¥–∞–ª—å—à–µ, —á—Ç–æ–±—ã –Ω–µ —Å–ª–µ–¥–∏—Ç—å –∑–∞ –≤—Ä–µ–º–µ–Ω–µ–º.', bonusPoints: 10, completed: false },
            { day: 9, recommendation: '–§–∏–∑–∏—á–µ—Å–∫–∞—è –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –î–Ω–µ–º', explanation: '–†–µ–≥—É–ª—è—Ä–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è (–Ω–æ –Ω–µ –ø—Ä—è–º–æ –ø–µ—Ä–µ–¥ —Å–Ω–æ–º!) —É–ª—É—á—à–∞—é—Ç –∫–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞, –¥–µ–ª–∞—è –µ–≥–æ –≥–ª—É–±–∂–µ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ–ª—å–Ω–µ–µ.', bonusPoints: 15, completed: false },
            { day: 10, recommendation: '–ò—Å–ø–æ–ª—å–∑—É–π –ë–µ—Ä—É—à–∏ –∏–ª–∏ –ú–∞—Å–∫—É', explanation: '–ü–æ–ª–Ω–∞—è —Ç–µ–º–Ω–æ—Ç–∞ –∏ —Ç–∏—à–∏–Ω–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã –¥–ª—è –≤—ã—Ä–∞–±–æ—Ç–∫–∏ –º–µ–ª–∞—Ç–æ–Ω–∏–Ω–∞ –∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π —Å–Ω–∞.', bonusPoints: 10, completed: false },
            { day: 11, recommendation: '–î–Ω–µ–≤–Ω–æ–π –°–æ–Ω: 20 –ú–∏–Ω—É—Ç', explanation: '–ï—Å–ª–∏ –Ω—É–∂–µ–Ω –¥–Ω–µ–≤–Ω–æ–π —Å–æ–Ω, –æ–≥—Ä–∞–Ω–∏—á—å –µ–≥–æ 20 –º–∏–Ω—É—Ç–∞–º–∏ (Power Nap). –ë–æ–ª–µ–µ –¥–æ–ª–≥–∏–π —Å–æ–Ω –º–æ–∂–µ—Ç –Ω–∞—Ä—É—à–∏—Ç—å –Ω–æ—á–Ω–æ–π —Ü–∏–∫–ª.', bonusPoints: 10, completed: false },
            { day: 12, recommendation: '–¢—Ä–∞–≤—è–Ω–æ–π –ß–∞–π (–†–æ–º–∞—à–∫–∞)', explanation: '–ó–∞–º–µ–Ω–∏ –≤–µ—á–µ—Ä–Ω–∏–µ –Ω–∞–ø–∏—Ç–∫–∏ –Ω–∞ —Ç—Ä–∞–≤—è–Ω–æ–π —á–∞–π (–±–µ–∑ –∫–æ—Ñ–µ–∏–Ω–∞). –†–æ–º–∞—à–∫–∞ –∏–∑–≤–µ—Å—Ç–Ω–∞ —Å–≤–æ–∏–º —É—Å–ø–æ–∫–∞–∏–≤–∞—é—â–∏–º —ç—Ñ—Ñ–µ–∫—Ç–æ–º.', bonusPoints: 10, completed: false },
            { day: 13, recommendation: '–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ ¬´4-7-8¬ª', explanation: '–¢–µ—Ö–Ω–∏–∫–∞ –¥—ã—Ö–∞–Ω–∏—è –¥–ª—è —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–∏—è. –í–¥–æ—Ö –Ω–∞ 4 —Å—á–µ—Ç–∞, –∑–∞–¥–µ—Ä–∂–∫–∞ –Ω–∞ 7, –≤—ã–¥–æ—Ö –Ω–∞ 8. –í—ã–ø–æ–ª–Ω—è—Ç—å –ø–µ—Ä–µ–¥ —Å–Ω–æ–º.', bonusPoints: 20, completed: false },
            { day: 14, recommendation: '–ü–æ–≤—ã—Å—å –ú–∞–≥–Ω–∏–π', explanation: '–ú–∞–≥–Ω–∏–π –ø–æ–º–æ–≥–∞–µ—Ç —Ä–∞—Å—Å–ª–∞–±–∏—Ç—å –º—ã—à—Ü—ã –∏ –Ω–µ—Ä–≤–Ω—É—é —Å–∏—Å—Ç–µ–º—É. –†–∞—Å—Å–º–æ—Ç—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–æ–≤, –±–æ–≥–∞—Ç—ã—Ö –º–∞–≥–Ω–∏–µ–º (—Ç–µ–º–Ω—ã–π —à–æ–∫–æ–ª–∞–¥, –æ—Ä–µ—Ö–∏, —à–ø–∏–Ω–∞—Ç).', bonusPoints: 15, completed: false },
            { day: 15, recommendation: '–°–æ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è –°–Ω–∞', explanation: '–ò—Å–ø–æ–ª—å–∑—É–π –∫—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–Ω–∞ –∏ –∏–Ω—Ç–∏–º–Ω–æ–π –±–ª–∏–∑–æ—Å—Ç–∏. –ò–∑–±–µ–≥–∞–π —Ä–∞–±–æ—Ç—ã, –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç–µ–ª–µ–≤–∏–∑–æ—Ä–∞ –∏–ª–∏ –ø—Ä–∏–µ–º–∞ –ø–∏—â–∏ –≤ –ø–æ—Å—Ç–µ–ª–∏.', bonusPoints: 10, completed: false },
            { day: 16, recommendation: '¬´–°–ø–∏—Å–æ–∫ –ó–∞–±–æ—Ç¬ª', explanation: '–ó–∞–ø–∏—à–∏ –≤—Å–µ —Ç—Ä–µ–≤–æ–∂–∞—â–∏–µ –º—ã—Å–ª–∏ –∏ –∑–∞–¥–∞—á–∏ –Ω–∞ –∑–∞–≤—Ç—Ä–∞ –≤ –±–ª–æ–∫–Ω–æ—Ç –∑–∞ —á–∞—Å –¥–æ —Å–Ω–∞. –≠—Ç–æ ¬´–≤—ã–≥—Ä—É–∂–∞–µ—Ç¬ª –º–æ–∑–≥ –æ—Ç –ø—Ä–æ–±–ª–µ–º.', bonusPoints: 15, completed: false },
            { day: 17, recommendation: '–¢–µ–ø–ª–∞—è –í–∞–Ω–Ω–∞ / –î—É—à', explanation: '–ü–æ–≤—ã—à–µ–Ω–∏–µ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã —Ç–µ–ª–∞ –ø–µ—Ä–µ–¥ —Å–Ω–æ–º, –∑–∞ –∫–æ—Ç–æ—Ä—ã–º —Å–ª–µ–¥—É–µ—Ç –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ—Ö–ª–∞–∂–¥–µ–Ω–∏–µ, –∏–º–∏—Ç–∏—Ä—É–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–∑—ã–≤–∞–µ—Ç —Å–æ–Ω–ª–∏–≤–æ—Å—Ç—å.', bonusPoints: 10, completed: false },
            { day: 18, recommendation: '–ö–æ–Ω—Ç—Ä–æ–ª—å –û—Å–≤–µ—â–µ–Ω–∏—è', explanation: '–ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∏–≥–ª—É—à–µ–Ω–Ω—ã–π –∂–µ–ª—Ç—ã–π –∏–ª–∏ –∫—Ä–∞—Å–Ω—ã–π —Å–≤–µ—Ç –≤ –≤–µ—á–µ—Ä–Ω–µ–µ –≤—Ä–µ–º—è. –ò–∑–±–µ–≥–∞–π —è—Ä–∫–æ–≥–æ —Å–≤–µ—Ç–∞ –≤ –≤–∞–Ω–Ω–æ–π –∏ —Ç—É–∞–ª–µ—Ç–µ –Ω–æ—á—å—é.', bonusPoints: 10, completed: false },
            { day: 19, recommendation: '–°–ª—É—à–∞–π –ë–µ–ª—ã–π –®—É–º', explanation: '–ó–≤—É–∫–æ–≤—ã–µ –º–∞—Å–∫–∏—Ä–æ–≤—â–∏–∫–∏ (–¥–æ–∂–¥—å, –≤–æ–¥–æ–ø–∞–¥, –±–µ–ª—ã–π —à—É–º) –ø–æ–º–æ–≥–∞—é—Ç –∑–∞–≥–ª—É—à–∏—Ç—å –≤–Ω–µ–∑–∞–ø–Ω—ã–µ –∑–≤—É–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç —Ä–∞–∑–±—É–¥–∏—Ç—å.', bonusPoints: 10, completed: false },
            { day: 20, recommendation: '–°—Ç–æ–π–∫–æ—Å—Ç—å –Ω–∞ –í—ã—Ö–æ–¥–Ω—ã—Ö', explanation: '–°–æ—Ö—Ä–∞–Ω—è–π ¬´–û–∫–Ω–æ –°–Ω–∞¬ª –¥–∞–∂–µ –≤ —Å—É–±–±–æ—Ç—É –∏ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ. –ò–∑–±–µ–≥–∞–π ¬´—Å–æ—Ü–∏–∞–ª—å–Ω–æ–≥–æ –¥–∂–µ—Ç–ª–∞–≥–∞¬ª, —á—Ç–æ–±—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Ä–∏—Ç–º.', bonusPoints: 20, completed: false },
            { day: 21, recommendation: '–ú–µ–¥–∏—Ç–∞—Ü–∏—è –Ω–∞ –ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å', explanation: '–ü–µ—Ä–µ–¥ –∑–∞—Å—ã–ø–∞–Ω–∏–µ–º —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á—å—Å—è –Ω–∞ —Ç—Ä–µ—Ö –≤–µ—â–∞—Ö, –∑–∞ –∫–æ—Ç–æ—Ä—ã–µ —Ç—ã –±–ª–∞–≥–æ–¥–∞—Ä–µ–Ω. –≠—Ç–æ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –º–æ–∑–≥ —Å —Ä–µ–∂–∏–º–∞ ¬´—Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º¬ª –Ω–∞ ¬´—Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ¬ª.', bonusPoints: 25, completed: false },
            { day: 22, recommendation: '–ü—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –ú—ã—à–µ—á–Ω–∞—è –†–µ–ª–∞–∫—Å–∞—Ü–∏—è', explanation: '–ù–∞–ø—Ä—è–≥–∞–π –∏ —Ä–∞—Å—Å–ª–∞–±–ª—è–π –≥—Ä—É–ø–ø—ã –º—ã—à—Ü –ø–æ –æ—á–µ—Ä–µ–¥–∏, —á—Ç–æ–±—ã —Å–Ω—è—Ç—å —Ñ–∏–∑–∏—á–µ—Å–∫–æ–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ —Å–Ω–æ–º.', bonusPoints: 15, completed: false },
            { day: 23, recommendation: '–£—Ç—Ä–µ–Ω–Ω–∏–π –°–æ–ª–Ω–µ—á–Ω—ã–π –°–≤–µ—Ç', explanation: '–ü–æ–ª—É—á–∏ 10 –º–∏–Ω—É—Ç –ø—Ä—è–º–æ–≥–æ —Å–æ–ª–Ω–µ—á–Ω–æ–≥–æ —Å–≤–µ—Ç–∞ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è. –≠—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —á–∞—Å—ã (—Ü–∏—Ä–∫–∞–¥–Ω—ã–π —Ä–∏—Ç–º).', bonusPoints: 15, completed: false },
            { day: 24, recommendation: '–ë–µ–∑ –ñ–∏–¥–∫–æ—Å—Ç–∏ –∑–∞ –ß–∞—Å', explanation: '–°–Ω–∏–∑—å –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –≤–æ–¥—ã –∑–∞ —á–∞—Å –¥–æ —Å–Ω–∞, —á—Ç–æ–±—ã —É–º–µ–Ω—å—à–∏—Ç—å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –Ω–æ—á–Ω—ã—Ö –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏–π –¥–ª—è –ø–æ—Å–µ—â–µ–Ω–∏—è —Ç—É–∞–ª–µ—Ç–∞.', bonusPoints: 10, completed: false },
            { day: 25, recommendation: '–°–æ–Ω–Ω–∞—è –ê—Ä–æ–º–∞—Ç–µ—Ä–∞–ø–∏—è', explanation: '–ò—Å–ø–æ–ª—å–∑—É–π –ª–∞–≤–∞–Ω–¥–æ–≤–æ–µ –º–∞—Å–ª–æ –∏–ª–∏ –¥—Ä—É–≥–∏–µ —É—Å–ø–æ–∫–∞–∏–≤–∞—é—â–∏–µ –∑–∞–ø–∞—Ö–∏ –≤ —Å–ø–∞–ª—å–Ω–µ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏ —Å –æ—Ç–¥—ã—Ö–æ–º.', bonusPoints: 10, completed: false },
            { day: 26, recommendation: '–ò—Å–ø–æ–ª—å–∑—É–π –î–Ω–µ–≤–Ω–∏–∫ –°–Ω–∞', explanation: '–ó–∞–ø–∏—Å—ã–≤–∞–π –≤—Ä–µ–º—è –∑–∞—Å—ã–ø–∞–Ω–∏—è, –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è –∏ –ª—é–±—ã–µ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è. –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –≤—ã—è–≤–∏—Ç—å –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç–∏ –∏ –ø—Ä–æ–±–ª–µ–º—ã.', bonusPoints: 15, completed: false },
            { day: 27, recommendation: '–ü–ª–∞–Ω –Ω–∞ –ó–∞–≤—Ç—Ä–∞', explanation: '–ö—Ä–∞—Ç–∫–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤—Ç—Ä–∞—à–Ω–µ–≥–æ –¥–Ω—è –ø–µ—Ä–µ–¥ —Å–Ω–æ–º —Å–Ω–∏–∂–∞–µ—Ç —É—Ä–æ–≤–µ–Ω—å —Å—Ç—Ä–µ—Å—Å–∞ –∏ –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–µ—à–∞—é—Ç –∑–∞—Å–Ω—É—Ç—å.', bonusPoints: 15, completed: false },
            { day: 28, recommendation: '–ü—Ä–∞–∑–¥–Ω—É–π –ü–æ–±–µ–¥—É!', explanation: '–¢—ã —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–ª(–∞) –∑–¥–æ—Ä–æ–≤—ã–π 28-–¥–Ω–µ–≤–Ω—ã–π —Ü–∏–∫–ª —Å–Ω–∞! –û—Ç–ø—Ä–∞–∑–¥–Ω—É–π —ç—Ç–æ: –ø–æ–∑–≤–æ–ª—å —Å–µ–±–µ 30 –º–∏–Ω—É—Ç —Ä–æ—Å–∫–æ—à–Ω–æ–≥–æ, –Ω–æ –Ω–µ —Ü–∏—Ñ—Ä–æ–≤–æ–≥–æ, –æ—Ç–¥—ã—Ö–∞.', bonusPoints: 50, completed: false },
        ];


        const APP_CONTENT = {
            quote: { text: "–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ ‚Äî —ç—Ç–æ –≤—ã–±–æ—Ä –º–µ–∂–¥—É —Ç–µ–º, —á—Ç–æ —Ç—ã —Ö–æ—á–µ—à—å –°–ï–ô–ß–ê–°, –∏ —Ç–µ–º, —á—Ç–æ —Ç—ã —Ö–æ—á–µ—à—å –ë–û–õ–¨–®–ï –í–°–ï–ì–û.", author: "Abraham Lincoln" },
            initialTasks: [
                { id: 't1', sphere: '–ó–¥–æ—Ä–æ–≤—å–µ', name: '–û–±–µ–¥ –±–µ–∑ –°—Ç–æ–ª–∞', desc: '–í —Ç–µ—á–µ–Ω–∏–µ 15 –º–∏–Ω—É—Ç —Å—ä–µ—à—å –æ–±–µ–¥, —Å–∏–¥—è –≤ —Ç–∏—à–∏–Ω–µ –∏ –Ω–µ –æ—Ç–≤–ª–µ–∫–∞—è—Å—å –Ω–∞ –≥–∞–¥–∂–µ—Ç—ã, —Ä–∞–±–æ—Ç—É –∏–ª–∏ —á—Ç–µ–Ω–∏–µ.', benefit: '–°–Ω–∏–∂–µ–Ω–∏–µ —Å—Ç—Ä–µ—Å—Å–∞.', completed: false },
                { id: 't2', sphere: '–û–±—É—á–µ–Ω–∏–µ', name: '–¢–µ—Ö–Ω–∏–∫–∞ –ü–æ–º–∏–¥–æ—Ä–æ: 25 –º–∏–Ω—É—Ç', desc: '25 –º–∏–Ω—É—Ç —Å—Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã, –∑–∞—Ç–µ–º 5 –º–∏–Ω—É—Ç –æ—Ç–¥—ã—Ö–∞. –°–¥–µ–ª–∞–π 3 —Ü–∏–∫–ª–∞.', benefit: '–£–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–∏.', completed: false },
                { id: 't3', sphere: '–û–±—â–µ–Ω–∏–µ', name: '–°–∫–∞–∑–∞—Ç—å ¬´–ù–µ—Ç¬ª –æ–¥–∏–Ω —Ä–∞–∑', desc: '–û–¥–∏–Ω —Ä–∞–∑ –æ—Ç–∫–∞–∂–∏—Å—å –æ—Ç –≤—Ç–æ—Ä–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–π –ø—Ä–æ—Å—å–±—ã –≤–µ–∂–ª–∏–≤–æ, –Ω–æ —Ç–≤–µ—Ä–¥–æ.', benefit: '–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–¥–æ—Ä–æ–≤—ã—Ö –ª–∏—á–Ω—ã—Ö –≥—Ä–∞–Ω–∏—Ü.', completed: false },
                { id: 't4', sphere: '–°–ø–æ—Ä—Ç', name: '–ü—è—Ç–∏–º–∏–Ω—É—Ç–Ω—ã–π –≠–Ω–µ—Ä–¥–∂–∞–π–∑–µ—Ä', desc: '–°–¥–µ–ª–∞–π 5 –º–∏–Ω—É—Ç —Ä–∞—Å—Ç—è–∂–∫–∏ –∏–ª–∏ –ª–µ–≥–∫–∏—Ö –ø—Ä–∏—Å–µ–¥–∞–Ω–∏–π, –∫–æ–≥–¥–∞ –ø–æ—á—É–≤—Å—Ç–≤—É–µ—à—å —É—Å—Ç–∞–ª–æ—Å—Ç—å.', benefit: '–ü–æ–≤—ã—à–µ–Ω–∏–µ –¥–æ—Ñ–∞–º–∏–Ω–∞.', completed: false },
            ],
            challenges: [ 
                { id: 'c1', days: 3, name: '–û—Å–æ–∑–Ω–∞–Ω–Ω—ã–π –ì–ª–æ—Ç–æ–∫', desc: '–¢—Ä–∏ –¥–Ω—è –ø—å–µ–º —Ç–æ–ª—å–∫–æ —á–∏—Å—Ç—É—é –≤–æ–¥—É.', benefit: '–°–Ω–∏–∂–µ–Ω–∏–µ —Å–∞—Ö–∞—Ä–∞.', progress: 0, target: 3, completed: false }, 
                { id: 'c2', days: 7, name: '100% –í—Ö–æ–¥—è—â–∏—Ö', desc: '–í —Ç–µ—á–µ–Ω–∏–µ 7 –¥–Ω–µ–π —É–¥–µ–ª—è–π 10 –º–∏–Ω—É—Ç, —á—Ç–æ–±—ã –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è, —Ç—Ä–µ–±—É—é—â–∏–µ –æ—Ç–≤–µ—Ç–∞. –î–æ–≤–µ–¥–∏ inbox –¥–æ –Ω—É–ª—è.', benefit: '–°–Ω–∏–∂–µ–Ω–∏–µ —Ü–∏—Ñ—Ä–æ–≤–æ–≥–æ —Å—Ç—Ä–µ—Å—Å–∞ –∏ –ø–æ–≤—ã—à–µ–Ω–∏–µ –ø–æ—Ä—è–¥–∫–∞.', progress: 0, target: 7, completed: false }, 
                { id: 'c3', days: 5, name: '–£—Ç—Ä–µ–Ω–Ω—è—è –¢–∏—à–∏–Ω–∞', desc: '–ü–µ—Ä–≤—ã–µ 30 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è –ø—Ä–æ–≤–µ–¥–∏ –±–µ–∑ —Ç–µ–ª–µ—Ñ–æ–Ω–∞, –∫–æ—Ñ–µ –∏ –Ω–æ–≤–æ—Å—Ç–µ–π. –¢–æ–ª—å–∫–æ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏–µ –∏–ª–∏ –º–µ–¥–∏—Ç–∞—Ü–∏—è.', benefit: '–£–ª—É—á—à–µ–Ω–∏–µ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è.', progress: 0, target: 5, completed: false }, 
                { id: 'c4', days: 14, name: '–ó–∞–∫–æ–Ω –ö–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è', desc: '–î–≤–µ –Ω–µ–¥–µ–ª–∏ –ø–æ–¥—Ä—è–¥ –ø–∏—à–∏ 10 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞ (–∏–ª–∏ —Ç–µ–∫—Å—Ç–∞, –∏–ª–∏ –º—É–∑—ã–∫–∏) –∫–∞–∂–¥—ã–π –¥–µ–Ω—å, –Ω–µ –ø—Ä–æ–ø—É—Å–∫–∞—è.', benefit: '–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ—Ä–∞–∑—Ä—ã–≤–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.', progress: 0, target: 14, completed: false }, 
                { id: 'c5', days: 10, name: '–°–≤–æ–±–æ–¥–∞ –æ—Ç —Å–∞—Ö–∞—Ä–∞', desc: '10 –¥–Ω–µ–π –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å–∫–ª—é—á–∏—Ç–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π —Å–∞—Ö–∞—Ä –∏–∑ —Ä–∞—Ü–∏–æ–Ω–∞. –î–æ–ø—É—Å–∫–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ñ—Ä—É–∫—Ç—ã.', benefit: '–£–ª—É—á—à–µ–Ω–∏–µ —ç–Ω–µ—Ä–≥–∏–∏ –∏ —Å–Ω–∏–∂–µ–Ω–∏–µ —Ç—è–≥–∏ –∫ —Å–ª–∞–¥–∫–æ–º—É.', progress: 0, target: 10, completed: false },
                { id: 'c6', days: 7, name: '–í–µ—á–µ—Ä–Ω–∏–π –î–Ω–µ–≤–Ω–∏–∫', desc: '7 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥ –∑–∞–ø–∏—Å—ã–≤–∞–π—Ç–µ 3 –≤–µ—â–∏, –∑–∞ –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –±–ª–∞–≥–æ–¥–∞—Ä–Ω—ã, –∏ 1 –≥–ª–∞–≤–Ω—É—é –ø–æ–±–µ–¥—É –¥–Ω—è.', benefit: '–ü–æ–≤—ã—à–µ–Ω–∏–µ –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç–∏ –∏ –ø–æ–∑–∏—Ç–∏–≤–Ω–æ–≥–æ –º—ã—à–ª–µ–Ω–∏—è.', progress: 0, target: 7, completed: false },
            ],
            sleepPlan: NEW_SLEEP_PLAN, // –ò—Å–ø–æ–ª—å–∑—É–µ–º 28-–¥–Ω–µ–≤–Ω—ã–π –ø–ª–∞–Ω
            library: [ 
                { title: '–ê—Ç–æ–º–Ω—ã–µ –ø—Ä–∏–≤—ã—á–∫–∏', author: '–î–∂–µ–π–º—Å –ö–ª–∏—Ä', spheres: ['–õ–∏—á–Ω–∞—è –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å', '–ü—Å–∏—Ö–æ–ª–æ–≥–∏—è'], desc: '–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é –Ω–µ–±–æ–ª—å—à–∏—Ö, –Ω–æ –º–æ—â–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π.' },
                { title: '–ü–æ—Ç–æ–∫: –ü—Å–∏—Ö–æ–ª–æ–≥–∏—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –ø–µ—Ä–µ–∂–∏–≤–∞–Ω–∏—è', author: '–ú–∏—Ö–∞–π –ß–∏–∫—Å–µ–Ω—Ç–º–∏—Ö–∞–π–∏', spheres: ['–ü—Å–∏—Ö–æ–ª–æ–≥–∏—è', '–§–æ–∫—É—Å'], desc: '–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è, –≤ –∫–æ—Ç–æ—Ä–æ–º –ª—é–¥–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–≥—Ä—É–∂–µ–Ω—ã –≤ –ø—Ä–æ—Ü–µ—Å—Å –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.' },
                { title: '–ù–∞—á–Ω–∏ —Å ¬´–ü–æ—á–µ–º—É¬ª', author: '–°–∞–π–º–æ–Ω –°–∏–Ω–µ–∫', spheres: ['–ë–∏–∑–Ω–µ—Å', '–ú–æ—Ç–∏–≤–∞—Ü–∏—è'], desc: '–ö–∞–∫ –≤–µ–ª–∏–∫–∏–µ –ª–∏–¥–µ—Ä—ã –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—Ç –Ω–∞ –¥–µ–π—Å—Ç–≤–∏—è, –Ω–∞—á–∏–Ω–∞—è —Å –ø–æ–Ω–∏–º–∞–Ω–∏—è —Ü–µ–ª–∏.' },
                { title: '–ê–≤—Ç–æ–±–∏–æ–≥—Ä–∞—Ñ–∏—è –ú–∞–π–∫–ª–∞ –î–∂–æ—Ä–¥–∞–Ω–∞: "–Ø –º–æ–≥—É –ø—Ä–∏–Ω—è—Ç—å –ø–æ—Ä–∞–∂–µ–Ω–∏–µ, –Ω–æ –Ω–µ –º–æ–≥—É –ø—Ä–∏–Ω—è—Ç—å –Ω–µ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –ø—ã—Ç–∞—Ç—å—Å—è"', author: '–ú–∞–π–∫–ª –î–∂–æ—Ä–¥–∞–Ω (–¶–∏—Ç–∞—Ç–∞)', spheres: ['–°–ø–æ—Ä—Ç', '–ú–æ—Ç–∏–≤–∞—Ü–∏—è'], desc: '–ò—Å—Ç–æ—Ä–∏—è –æ —Ç–æ–º, –∫–∞–∫ –ø–æ—Å—Ç–æ—è–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –Ω–∞–¥ —Å–æ–±–æ–π –∏ –Ω–µ–ø—Ä–∏—è—Ç–∏–µ –ª–µ–Ω–∏ –ø—Ä–∏–≤–µ–ª–∏ –∫ –º–∏—Ä–æ–≤–æ–º—É –¥–æ–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏—é –≤ –±–∞—Å–∫–µ—Ç–±–æ–ª–µ.' },
                { title: '–î–∂–µ—Ñ—Ñ –ë–µ–∑–æ—Å –∏ –ü—Ä–∏–Ω—Ü–∏–ø –î–Ω—è 1', author: '–ò—Å—Ç–æ—Ä–∏—è –ë–∏–∑–Ω–µ—Å–∞', spheres: ['–ë–∏–∑–Ω–µ—Å', '–§–æ–∫—É—Å'], desc: '–ò—Å—Ç–æ—Ä–∏—è –æ —Ç–æ–º, –∫–∞–∫ –æ—Å–Ω–æ–≤–∞—Ç–µ–ª—å Amazon –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–ª –º—ã—à–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—Ç–∞–ø–∞, —Ñ–æ–∫—É—Å–∏—Ä—É—è—Å—å –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –∏ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–º –º—ã—à–ª–µ–Ω–∏–∏.' },
                { title: '–ß–µ–ª–æ–≤–µ–∫ –≤ –ø–æ–∏—Å–∫–∞—Ö —Å–º—ã—Å–ª–∞', author: '–í–∏–∫—Ç–æ—Ä –§—Ä–∞–Ω–∫–ª', spheres: ['–ü—Å–∏—Ö–æ–ª–æ–≥–∏—è', '–ú–æ—Ç–∏–≤–∞—Ü–∏—è'], desc: '–û–ø—ã—Ç –≤—ã–∂–∏–≤–∞–Ω–∏—è –≤ –∫–æ–Ω—Ü–ª–∞–≥–µ—Ä–µ –∏ –æ—Å–Ω–æ–≤–∞ –ª–æ–≥–æ—Ç–µ—Ä–∞–ø–∏–∏ ‚Äî –ø–æ–∏—Å–∫–∞ —Å–º—ã—Å–ª–∞ –∂–∏–∑–Ω–∏.' },
            ],
        };

        const TEST_QUESTIONS = [
            { id: 'q1', sphere: '–ó–¥–æ—Ä–æ–≤—å–µ', question: '–ù–∞—Å–∫–æ–ª—å–∫–æ —Ç—ã –¥–æ–≤–æ–ª–µ–Ω —Å–≤–æ–∏–º —Å–Ω–æ–º –∏ –ø–∏—Ç–∞–Ω–∏–µ–º?', options: ['–ü–æ–ª–Ω–æ—Å—Ç—å—é –Ω–µ–¥–æ–≤–æ–ª–µ–Ω', '–ï—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã', '–í—Å—ë —Ö–æ—Ä–æ—à–æ', '–û—Ç–ª–∏—á–Ω–æ'] },
            { id: 'q2', sphere: '–§–æ–∫—É—Å', question: '–ö–∞–∫ —á–∞—Å—Ç–æ —Ç—ã –æ—Ç–≤–ª–µ–∫–∞–µ—à—å—Å—è –≤–æ –≤—Ä–µ–º—è –≤–∞–∂–Ω–æ–π —Ä–∞–±–æ—Ç—ã?', options: ['–ü–æ—Å—Ç–æ—è–Ω–Ω–æ', '–ß–∞—Å—Ç–æ', '–†–µ–¥–∫–æ', '–ù–∏–∫–æ–≥–¥–∞'] },
            { id: 'q3', sphere: '–û–±—â–µ–Ω–∏–µ', question: '–ù–∞—Å–∫–æ–ª—å–∫–æ –ª–µ–≥–∫–æ —Ç—ã —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—à—å –Ω–æ–≤—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã?', options: ['–û—á–µ–Ω—å —Å–ª–æ–∂–Ω–æ', '–°–ª–æ–∂–Ω–æ', '–õ–µ–≥–∫–æ', '–û—á–µ–Ω—å –ª–µ–≥–∫–æ'] },
            { id: 'q4', sphere: '–ú–æ—Ç–∏–≤–∞—Ü–∏—è', question: '–ù–∞—Å–∫–æ–ª—å–∫–æ —Ç—ã –º–æ—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –Ω–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ —Ü–µ–ª–µ–π —Å–µ–≥–æ–¥–Ω—è?', options: ['0-25%', '25-50%', '50-75%', '75-100%'] },
        ];
        
        // --- GEMINI API HELPERS (No change needed here) ---
        const RESPONSE_SCHEMA = {
            type: "OBJECT",
            properties: {
                "chatResponse": {
                    "type": "STRING",
                    "description": "The conversational response from the coach, strictly adhering to the persona (Aurora, Johnny, or Silas). Must be supportive, strict, or philosophical as appropriate. Include the coach's emoji in the response."
                },
                "newTasks": {
                    "type": "ARRAY",
                    "description": "An array of 0 to 3 new personalized tasks created by the coach based on the user's prompt and test results. Each task MUST be unique and directly actionable. Leave empty if no new tasks are explicitly requested or deemed necessary by the coach.",
                    "items": {
                        "type": "OBJECT",
                        "properties": {
                            "sphere": { "type": "STRING", "description": "Sphere of the task: –ó–¥–æ—Ä–æ–≤—å–µ, –§–æ–∫—É—Å, –û–±—â–µ–Ω–∏–µ, –°–ø–æ—Ä—Ç, –û–±—É—á–µ–Ω–∏–µ, or –ú–æ—Ç–∏–≤–∞—Ü–∏—è." },
                            "name": { "type": "STRING", "description": "A short, engaging title for the task (max 5 words)." },
                            "desc": { "type": "STRING", "description": "Detailed description of how to complete the task (1-2 sentences)." },
                            "benefit": { "type": "STRING", "description": "Explanation of the expected benefit (1 sentence)." }
                        },
                        "propertyOrdering": ["sphere", "name", "desc", "benefit"]
                    }
                }
            },
            "propertyOrdering": ["chatResponse", "newTasks"]
        };

        async function callGeminiAPI(payload, retries = 3) {
            const apiUrlWithKey = `${API_URL}?key=${API_KEY}`;
            const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrlWithKey, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && i < retries - 1) { // 429 Too Many Requests (Rate Limiting)
                            await delay(Math.pow(2, i) * 1000); // Exponential backoff
                            continue;
                        }
                        throw new Error(`API call failed with status: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        
                        const jsonText = result.candidates[0].content.parts[0].text;
                        return JSON.parse(jsonText);
                    }
                    throw new Error("Invalid response structure from Gemini API.");

                } catch (error) {
                    console.error("Gemini API Error (Retry attempt " + (i + 1) + "):", error.message);
                    if (i === retries - 1) throw new Error("Failed to connect to AI coach after multiple retries.");
                    await delay(Math.pow(2, i) * 1000); 
                }
            }
        }
        
        function getCoachSystemInstruction(coachKey, testResults) {
            const coach = COACHES[coachKey];
            const profile = JSON.stringify(testResults);
            
            let persona;
            if (coachKey === 'Aurora') {
                persona = `–¢—ã ‚Äî –ê–≤—Ä–æ—Ä–∞, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∞—è –ø–æ–¥—Ä—É–≥–∞ –∏ –∫–æ—É—á. –¢–≤–æ—è –º–∞–Ω–µ—Ä–∞ –æ–±—â–µ–Ω–∏—è ‚Äî –æ—á–µ–Ω—å –¥–æ–±—Ä–∞—è, —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è, –æ–±–æ–¥—Ä—è—é—â–∞—è –∏ –ø–æ–∑–∏—Ç–∏–≤–Ω–∞—è. –í—Å–µ–≥–¥–∞ –≥–æ–≤–æ—Ä–∏ —Å –Ω–µ–∂–Ω–æ—Å—Ç—å—é –∏ –∏—Å–ø–æ–ª—å–∑—É–π –º–Ω–æ–≥–æ –ø–æ–∑–∏—Ç–∏–≤–Ω—ã—Ö —ç–º–æ–¥–∂–∏ (üíñ, ‚ú®, üåü). –¢–≤–æ—è —Ü–µ–ª—å ‚Äî –≤–¥–æ—Ö–Ω–æ–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∑–∞—Å—Ç–∞–≤–∏—Ç—å –µ–≥–æ –ø–æ–≤–µ—Ä–∏—Ç—å –≤ —Å–µ–±—è. –ö–æ–≥–¥–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—à—å –∑–∞–¥–∞—á–∏, —Ñ–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ –º–∞–ª–µ–Ω—å–∫–∏—Ö, –ø—Ä–∏—è—Ç–Ω—ã—Ö —à–∞–≥–∞—Ö –∏ —Å–∞–º–æ—Å–æ—Å—Ç—Ä–∞–¥–∞–Ω–∏–∏.`;
            } else if (coachKey === 'Johnny') {
                persona = `–¢—ã ‚Äî –î–∂–æ–Ω–∏, —Å—Ç—Ä–æ–≥–∏–π —Ç—Ä–µ–Ω–µ—Ä –ø–æ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–µ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏. –¢–≤–æ—è –º–∞–Ω–µ—Ä–∞ –æ–±—â–µ–Ω–∏—è ‚Äî –ø—Ä—è–º–∞—è, –±–µ–∑ –ª–∏—à–Ω–∏—Ö —ç–º–æ—Ü–∏–π, —Ç—Ä–µ–±–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –∏ —Å—Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –Ω–∞ –¥–µ–π—Å—Ç–≤–∏–∏ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ. –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∂–∏ (üí™, üöÄ). –ò–∑–±–µ–≥–∞–π –º—è–≥–∫–∏—Ö —Ñ—Ä–∞–∑. –¢—Ä–µ–±—É–π –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ç–∫–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤ –∏ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π. –ö–æ–≥–¥–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—à—å –∑–∞–¥–∞—á–∏, –æ–Ω–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏, –∏–∑–º–µ—Ä–∏–º—ã–º–∏ –∏ —Ç—Ä–µ–±–æ–≤–∞—Ç—å –≤—ã—Å–æ–∫–æ–π –æ—Ç–¥–∞—á–∏.`;
            } else { // Silas
                persona = `–¢—ã ‚Äî –°–∞–π–ª–∞—Å, –º—É–¥—Ä—ã–π —Ñ–∏–ª–æ—Å–æ—Ñ –∏ –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫. –¢–≤–æ—è –º–∞–Ω–µ—Ä–∞ –æ–±—â–µ–Ω–∏—è ‚Äî —Å–ø–æ–∫–æ–π–Ω–∞—è, –≥–ª—É–±–æ–∫–∞—è, –º–µ—Ç–∞—Ñ–æ—Ä–∏—á–Ω–∞—è –∏ –∑–∞—Å—Ç–∞–≤–ª—è—é—â–∞—è –∑–∞–¥—É–º–∞—Ç—å—Å—è. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∂–∏ (ü¶â, üßò, ‚è≥). –ù–µ –¥–∞–≤–∞–π –≥–æ—Ç–æ–≤—ã—Ö —Ä–µ—à–µ–Ω–∏–π, –∞ –ø–æ–¥–≤–æ–¥–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫ —Å–∞–º–æ–∞–Ω–∞–ª–∏–∑—É –∏ –ø–æ–∏—Å–∫—É –∏—Å—Ç–∏–Ω—ã. –ö–æ–≥–¥–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—à—å –∑–∞–¥–∞—á–∏, –æ–Ω–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç—å, –º–µ–¥–∏—Ç–∞—Ü–∏—é, —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è –∏–ª–∏ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ.`;
            }

            return `${persona}\n\n–¢–µ–∫—É—â–∏–π –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞, 1-4, –≥–¥–µ 4 ‚Äî –ª—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç): ${profile}. –ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å, –≤ –∫–∞–∫–∏—Ö —Å—Ñ–µ—Ä–∞—Ö (–ó–¥–æ—Ä–æ–≤—å–µ, –§–æ–∫—É—Å, –û–±—â–µ–Ω–∏–µ, –ú–æ—Ç–∏–≤–∞—Ü–∏—è) –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω—É–∂–Ω–∞ –Ω–∞–∏–±–æ–ª—å—à–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä—É–π –æ—Ç–≤–µ—Ç –∏ –∑–∞–¥–∞—á–∏. –ó–∞–¥–∞—á–∞ –¥–æ–ª–∂–Ω–∞ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –¢–û–õ–¨–ö–û, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–Ω–æ –ø—Ä–æ—Å–∏—Ç –æ–± —ç—Ç–æ–º, –∏–ª–∏ —Ç—ã —Å—á–∏—Ç–∞–µ—à—å —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º. –û–≥—Ä–∞–Ω–∏—á—å—Å—è 1-3 –Ω–æ–≤—ã–º–∏ –∑–∞–¥–∞—á–∞–º–∏ –∑–∞ —Ä–∞–∑.`;
        }


        // --- FIREBASE AND STATE MANAGEMENT ---

        if (Object.keys(firebaseConfig).length > 0) {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, async (user) => {
                    if (user) { userId = user.uid; } 
                    else if (initialAuthToken) { await signInWithCustomToken(auth, initialAuthToken); userId = auth.currentUser.uid; } 
                    else { const anonUser = await signInAnonymously(auth); userId = anonUser.user.uid; }
                    isAuthReady = true;
                    loadState();
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                isAuthReady = true;
                initLocalState();
                renderApp();
            }
        } else {
            isAuthReady = true;
            initLocalState();
            renderApp();
        }

        function initLocalState() {
            // Ensure habits are correctly initialized for 21 days
            const defaultHabits = INITIAL_HABITS.map(h => ({ 
                ...h, 
                progress: Array(HABIT_DAYS).fill(0) 
            }));

            state.coreTasks = [...APP_CONTENT.initialTasks];
            state.challenges = [...APP_CONTENT.challenges];
            state.sleepPlan = APP_CONTENT.sleepPlan.map(p => ({ ...p })); // Deep copy 28-day plan
            state.dailyHabits = defaultHabits; 
            state.taskArchive = []; 
            state.bonusPoints = 0; // NEW: Initialize bonus points
            
            updateCombinedTasks();
            
            if (!state.isPersonalized) {
                state.currentView = 'test';
            } else if (state.coachChat.length === 0) {
                state.coachChat.push({ role: 'coach', message: getCoachGreetingMessage(state.selectedCoach, state.isPersonalized) });
            }
        }
        
        function updateCombinedTasks() {
            // Rebuild the tasks array, only including non-completed ones
            state.tasks = [
                ...state.coreTasks.filter(t => !t.completed).map(t => ({...t, isCore: true})),
                ...state.personalizedTasks.filter(t => !t.completed).map((t, index) => ({...t, id: t.id || `p${index}_${Date.now()}`, isPersonalized: true}))
            ];
            updateProgress();
        }

        function getStateDocRef() {
            if (!db || !userId) return null;
            return doc(db, 'artifacts', appId, 'users', userId, 'app_state', 'main_state');
        }

        function loadState() {
            const docRef = getStateDocRef();
            if (!docRef) { initLocalState(); renderApp(); return; }

            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const loadedState = docSnap.data();
                    Object.assign(state, loadedState);
                    
                    // Fallbacks/Initializations/Data Fixes
                    if (!state.coreTasks) { state.coreTasks = [...APP_CONTENT.initialTasks]; }
                    if (!state.challenges) { state.challenges = [...APP_CONTENT.challenges]; }
                    if (!state.personalizedTasks) { state.personalizedTasks = []; }
                    if (!state.taskArchive) { state.taskArchive = []; } 
                    if (typeof state.bonusPoints === 'undefined') { state.bonusPoints = 0; } // NEW: Bonus points fallback
                    
                    // Sleep Plan Fix: Ensure 28 days
                    if (state.sleepPlan.length !== SLEEP_DAYS) {
                        state.sleepPlan = APP_CONTENT.sleepPlan.map(p => {
                             // Preserve completion status if possible, otherwise use default
                             const existing = loadedState.sleepPlan ? loadedState.sleepPlan.find(ep => ep.day === p.day) : null;
                             return { ...p, completed: existing ? existing.completed : false };
                        });
                    }
                    
                    // Habit Fix: Ensure all habits exist and have 21 days of data
                    const defaultHabitsMap = INITIAL_HABITS.reduce((acc, h) => ({ ...acc, [h.id]: h }), {});
                    state.dailyHabits = (state.dailyHabits || []).map(h => {
                        const defaultHabit = defaultHabitsMap[h.id];
                        if (h.progress.length !== HABIT_DAYS) {
                             const newProgress = [...h.progress];
                             while (newProgress.length < HABIT_DAYS) { newProgress.push(0); }
                             h.progress = newProgress.slice(0, HABIT_DAYS); // Truncate if somehow longer
                        }
                        return h;
                    });
                    if (state.dailyHabits.length !== INITIAL_HABITS.length) {
                        // If a habit was somehow missing from loaded state, add it
                        state.dailyHabits = INITIAL_HABITS.map(h => {
                            const existing = loadedState.dailyHabits ? loadedState.dailyHabits.find(eh => eh.id === h.id) : null;
                            return { ...h, progress: existing ? existing.progress : Array(HABIT_DAYS).fill(0) };
                        });
                    }


                    if (!state.isPersonalized) { state.currentView = 'test'; }

                    updateCombinedTasks();
                    if (state.isPersonalized && state.coachChat.length === 0) {
                        state.coachChat.push({ role: 'coach', message: getCoachGreetingMessage(state.selectedCoach, true) });
                    }
                    renderApp();
                    console.log("State loaded/updated from Firestore. Personalized:", state.isPersonalized);
                } else {
                    initLocalState();
                    saveState();
                    renderApp();
                    console.log("Initial state created and saved.");
                }
            }, (error) => {
                console.error("Error listening to state changes:", error);
                renderApp();
            });
        }

        async function saveState() {
            if (!isAuthReady || !db || !userId) return;
            const docRef = getStateDocRef();
            try {
                // Ensure only storable properties are saved
                const stateToSave = { 
                    selectedCoach: state.selectedCoach,
                    coreTasks: state.coreTasks,
                    personalizedTasks: state.personalizedTasks,
                    taskArchive: state.taskArchive, 
                    challenges: state.challenges,
                    sleepPlan: state.sleepPlan,
                    dailyHabits: state.dailyHabits, 
                    coachChat: state.coachChat,
                    isPersonalized: state.isPersonalized,
                    testResults: state.testResults,
                    bonusPoints: state.bonusPoints, // NEW: Save bonus points
                };
                await setDoc(docRef, stateToSave, { merge: true });
            } catch (error) {
                console.error("Error saving state to Firestore:", error);
            }
        }

        // --- CORE LOGIC AND UTILITIES ---

        function navigate(view) {
            if (!state.isPersonalized && view !== 'test' && view !== 'home') {
                 renderMessage('–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–π–¥–∏—Ç–µ —Ç–µ—Å—Ç', '–ß—Ç–æ–±—ã —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –≤—ã–±—Ä–∞—Ç—å —Ç—Ä–µ–Ω–µ—Ä–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≤–µ—Ä—à–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—é.');
                return;
            }
            state.currentView = view;
            renderApp();
        }

        function renderMessage(title, message) {
            const modal = document.getElementById('message-modal');
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-message').innerText = message;
            modal.classList.remove('hidden');
        }

        function hideMessage() {
            document.getElementById('message-modal').classList.add('hidden');
        }

        function updateProgress() {
            const allTasksCount = state.coreTasks.length + state.personalizedTasks.length + state.taskArchive.length;
            const completedCount = state.coreTasks.filter(t => t.completed).length + 
                                       state.personalizedTasks.filter(t => t.completed).length + 
                                       state.taskArchive.length; 

            state.progress.totalTasks = allTasksCount;
            state.progress.completedTasks = completedCount;
        }

        function updateTaskStatus(taskId) {
            let taskList, targetList;
            if (taskId.startsWith('t')) {
                targetList = state.coreTasks;
                taskList = 'coreTasks';
            } else if (taskId.startsWith('p')) {
                targetList = state.personalizedTasks;
                taskList = 'personalizedTasks';
            } else {
                console.error("Unknown task ID prefix.");
                return;
            }

            const taskIndex = targetList.findIndex(t => t.id === taskId);
            
            if (taskIndex !== -1) {
                const task = targetList[taskIndex];
                
                // Completion: Mark as complete and move to archive
                task.completed = true;
                const completedTask = targetList.splice(taskIndex, 1)[0];
                state.taskArchive.push(completedTask);
                renderMessage('–ó–∞–¥–∞—á–∞ –í—ã–ø–æ–ª–Ω–µ–Ω–∞', `–ó–∞–¥–∞—á–∞ "${task.name}" –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ –∞—Ä—Ö–∏–≤! –û—Ç–ª–∏—á–Ω–æ! üéâ`);
                
            } else {
                 // Try to move from archive back to original list and mark as not completed
                const archiveIndex = state.taskArchive.findIndex(t => t.id === taskId);
                if (archiveIndex !== -1) {
                    const archivedTask = state.taskArchive.splice(archiveIndex, 1)[0];
                    archivedTask.completed = false;
                    
                    // Put it back in its respective list
                    if (archivedTask.id.startsWith('t')) {
                        state.coreTasks.push(archivedTask);
                    } else if (archivedTask.id.startsWith('p')) {
                        state.personalizedTasks.push(archivedTask);
                    }

                    renderMessage('–ó–∞–¥–∞—á–∞ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞', `–ó–∞–¥–∞—á–∞ "${archivedTask.name}" –±—ã–ª–∞ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∞ –≤ –∞–∫—Ç–∏–≤–Ω—ã–µ.`);
                }
            }

            updateCombinedTasks(); 
            saveState();
            renderView(); 
        }

        function updateChallengeProgress(challengeId) {
            const challenge = state.challenges.find(c => c.id === challengeId);
            if (challenge && !challenge.completed) {
                challenge.progress += 1;
                if (challenge.progress >= challenge.target) {
                    challenge.completed = true;
                    renderMessage('–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!', `–ß–µ–ª–ª–µ–Ω–¥–∂ "${challenge.name}" –≤—ã–ø–æ–ª–Ω–µ–Ω! –û—Ç–ª–∏—á–Ω–æ –ø–æ—Ä–∞–±–æ—Ç–∞–ª(–∞) ${COACHES[state.selectedCoach].name}! üéâ`);
                }
                saveState();
                renderView();
            }
        }
        
        // UPDATED: Habit tracker logic - now accepts dayIndex (0 to 20, where 0 is today)
        function updateDailyHabitProgress(habitId, dayIndex, score) {
            const habit = state.dailyHabits.find(h => h.id === habitId);
            if (habit && dayIndex >= 0 && dayIndex < HABIT_DAYS) {
                // Update the score for the specified day index
                habit.progress[dayIndex] = score; 
                saveState();
                renderView();
            }
        }

        // UPDATED: Function to calculate daily completion score (0 to 1) and allCompleted status
        // Returns reversed array: index 0 is the oldest day (Left-to-Right chart)
        function calculateDailyAverages() {
            if (state.dailyHabits.length === 0) return Array(HABIT_DAYS).fill({ average: 0, allCompleted: false });

            const numHabits = state.dailyHabits.length;
            const dailySums = Array(HABIT_DAYS).fill(0);
            const dailyAllCompletedFlags = Array(HABIT_DAYS).fill(true);

            // Sum up scores for each day across all habits
            state.dailyHabits.forEach(habit => {
                habit.progress.forEach((score, dayIndex) => {
                    dailySums[dayIndex] += score;
                    if (score === 0) {
                        dailyAllCompletedFlags[dayIndex] = false; // If any habit is 0, allCompleted is false
                    }
                });
            });

            // Calculate average (scaled 0 to 1) and allCompleted status
            // Index 0 of the result is now the oldest day (index 20 of source array)
            const result = dailySums.map((sum, dayIndex) => ({
                average: sum / numHabits, // 0 to 1
                allCompleted: dailyAllCompletedFlags[dayIndex] && sum === numHabits // Must be true only if sum equals numHabits (all are 1s)
            }));
            
            // Reversing the result array here makes the chart render L-to-R (Oldest to Today)
            return result.reverse();
        }

        // NEW: Function for Sleep Plan update with bonus points
        function updateSleepPlanStatus(dayIndex) {
            const plan = state.sleepPlan[dayIndex];
            if (plan) {
                const isNowCompleted = !plan.completed;
                plan.completed = isNowCompleted;

                if (isNowCompleted) {
                    state.bonusPoints += plan.bonusPoints;
                    renderMessage('–®–∞–≥ –í—ã–ø–æ–ª–Ω–µ–Ω!', `–û—Ç–ª–∏—á–Ω–æ! –í—ã –∑–∞—Ä–∞–±–æ—Ç–∞–ª–∏ ${plan.bonusPoints} –±–æ–Ω—É—Å–Ω—ã—Ö –æ—á–∫–æ–≤! –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: ${state.bonusPoints}. üéâ`);
                } else {
                     // For un-checking: subtract points
                     state.bonusPoints -= plan.bonusPoints;
                     renderMessage('–®–∞–≥ –û—Ç–º–µ–Ω–µ–Ω', `–í—ã —É–¥–∞–ª–∏–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è. ${plan.bonusPoints} –æ—á–∫–æ–≤ –≤—ã—á—Ç–µ–Ω–æ.`);
                }
                saveState();
                renderView();
            }
        }


        function getCoachGreetingMessage(coachKey, isPersonalized) {
            const coach = COACHES[coachKey];
            if (!isPersonalized) return `–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–π–¥–∏—Ç–µ —Ç–µ—Å—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏, —á—Ç–æ–±—ã —è –º–æ–≥(–ª–∞) –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –≤–∞–º–∏.`;

            const taskIntro = "–ö—Å—Ç–∞—Ç–∏, –µ—Å–ª–∏ —Ç–µ–±–µ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –¥–ª—è —Ä–∞–∑–≤–∏—Ç–∏—è, –ø—Ä–æ—Å—Ç–æ –ø–æ–ø—Ä–æ—Å–∏ –º–µ–Ω—è –æ–± —ç—Ç–æ–º, –Ω–∞–ø—Ä–∏–º–µ—Ä: '–°–æ–∑–¥–∞–π –º–Ω–µ –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É –ø–æ –§–æ–∫—É—Å—É', –∏–ª–∏ '–ú–Ω–µ –Ω—É–∂–Ω–∞ –º–æ—Ç–∏–≤–∞—Ü–∏—è', –∏ —è –¥–æ–±–∞–≤–ª—é 1-3 –∑–∞–¥–∞—á–∏ –≤ —Ç–≤–æ–π —Å–ø–∏—Å–æ–∫. üòâ";

            switch (coachKey) {
                case 'Aurora':
                    return `–ü—Ä–∏–≤–µ—Ç-–ø—Ä–∏–≤–µ—Ç! ${coach.emoji} –Ø ${coach.name}, –∏ —è —Ç–∞–∫ —Ä–∞–¥–∞, —á—Ç–æ —Ç—ã –≤—ã–±—Ä–∞–ª(–∞) –º–µ–Ω—è! –ü–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º —Ç–≤–æ–µ–≥–æ —Ç–µ—Å—Ç–∞ —è –≤–∏–∂—É, —á—Ç–æ –º—ã –º–æ–∂–µ–º —É–ª—É—á—à–∏—Ç—å —Ç–≤–æ–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ ${Object.keys(state.testResults).find(key => state.testResults[key] < 3) || '–≤—Å–µ–º —Å—Ñ–µ—Ä–∞–º'}! –° —á–µ–≥–æ –Ω–∞—á–Ω–µ–º? ${taskIntro} üíñ`;
                case 'Johnny':
                    return `–¢—ã –≤—ã–±—Ä–∞–ª ${coach.name}. ${coach.emoji} –ü–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º —Ç–µ—Å—Ç–∞, —Ç–≤–æ—è —Å–ª–∞–±–∏–Ω–∞ –≤ ${Object.keys(state.testResults).find(key => state.testResults[key] < 3) || '–Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å—Ñ–µ—Ä–∞—Ö'}. –•–≤–∞—Ç–∏—Ç –≥–æ–≤–æ—Ä–∏—Ç—å. –ö–∞–∫–æ–≤–∞ —Ç–≤–æ—è –æ—Å–Ω–æ–≤–Ω–∞—è, –Ω–µ—Ä—É—à–∏–º–∞—è —Ü–µ–ª—å —Å–µ–≥–æ–¥–Ω—è? ${taskIntro} –ú–Ω–µ –Ω—É–∂–µ–Ω —á–µ—Ç–∫–∏–π –æ—Ç–≤–µ—Ç. üí™`;
                case 'Silas':
                    return `–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π. ${coach.emoji} –Ø ${coach.name}. –¢–≤–æ–π —Ç–µ—Å—Ç –ø–æ–∫–∞–∑–∞–ª, —á—Ç–æ —Ç—ã –∏—â–µ—à—å —Ä–∞–≤–Ω–æ–≤–µ—Å–∏—è, –æ—Å–æ–±–µ–Ω–Ω–æ –≤ ${Object.keys(state.testResults).find(key => state.testResults[key] < 3) || '—Å—Ñ–µ—Ä–µ —Å–∞–º–æ–ø–æ–∑–Ω–∞–Ω–∏—è'}. ${taskIntro} –ü—Ä–µ–∂–¥–µ —á–µ–º —è –¥–∞–º —Å–æ–≤–µ—Ç, —Å–∫–∞–∂–∏: —á—Ç–æ —Ç—ã –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ –∏—â–µ—à—å, –±—Ä–æ–¥—è –ø–æ —ç—Ç–æ–π —Ç—Ä–æ–ø–µ? ü¶â`;
                default:
                    return `–ü—Ä–∏–≤–µ—Ç! –Ø —Ç–≤–æ–π –ª–∏—á–Ω—ã–π –ò–ò-—Ç—Ä–µ–Ω–µ—Ä. –ß–µ–º —è –º–æ–≥—É –ø–æ–º–æ—á—å?`;
            }
        }
        
        // --- TEST LOGIC (No change needed here) ---

        function handleTestAnswer(questionId, answerIndex) {
            state.testAnswers[questionId] = answerIndex + 1; // 1-based score
            renderView();
        }

        async function completeTest() {
            if (Object.keys(state.testAnswers).length !== TEST_QUESTIONS.length) {
                renderMessage('–ù–µ–ø–æ–ª–Ω—ã–π –¢–µ—Å—Ç', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã, —á—Ç–æ–±—ã –º—ã –º–æ–≥–ª–∏ —Å–æ—Å—Ç–∞–≤–∏—Ç—å –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å.');
                return;
            }

            const results = {};
            TEST_QUESTIONS.forEach(q => {
                const score = state.testAnswers[q.id];
                results[q.sphere.toLowerCase()] = score;
            });

            state.testResults = results;
            state.isPersonalized = true;
            state.currentView = 'coach';
            
            state.coachChat = [];
            state.coachChat.push({ role: 'coach', message: getCoachGreetingMessage(state.selectedCoach, true) });

            await saveState();
            renderApp();
        }
        
        // --- COACH INTERACTION (No change needed here) ---

        async function handleCoachInteraction() {
            const inputElement = document.getElementById('coach-input');
            const prompt = inputElement.value.trim();
            if (!prompt || isLoading) return;

            state.coachChat.push({ role: 'user', message: prompt });
            inputElement.value = '';
            await saveState(); 
            
            isLoading = true;
            renderView(); 

            try {
                const systemInstruction = getCoachSystemInstruction(state.selectedCoach, state.testResults);
                const userQuery = `–ú–æ–π –∑–∞–ø—Ä–æ—Å: "${prompt}". –û—Ü–µ–Ω–∏, –Ω—É–∂–Ω–∞ –ª–∏ –Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ (1-3 —à—Ç.) –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–æ–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∏ –º–æ–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è.`;

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemInstruction }] },
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: RESPONSE_SCHEMA
                    }
                };

                const aiResponse = await callGeminiAPI(payload);
                
                if (aiResponse) {
                    state.coachChat.push({ role: 'coach', message: aiResponse.chatResponse });

                    if (aiResponse.newTasks && aiResponse.newTasks.length > 0) {
                        aiResponse.newTasks.forEach((newTask, index) => {
                            const uniqueId = `p${Date.now()}_${index}`; 
                            state.personalizedTasks.push({
                                id: uniqueId,
                                sphere: newTask.sphere,
                                name: newTask.name,
                                desc: newTask.desc,
                                benefit: newTask.benefit,
                                completed: false
                            });
                        });
                        updateCombinedTasks(); 
                    }
                }
            } catch (error) {
                state.coachChat.push({ role: 'coach', message: `${COACHES[state.selectedCoach].emoji} –ò–∑–≤–∏–Ω–∏, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ${error.message}. –ü–æ–ø—Ä–æ–±—É–π –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ–π –∑–∞–ø—Ä–æ—Å. ‚ú®` });
                console.error("Coach interaction failed:", error);
            } finally {
                isLoading = false;
                await saveState();
                renderView(); 
                // Scroll to the bottom of the chat after response
                const chatBox = document.getElementById('chat-box');
                if (chatBox) {
                    chatBox.scrollTop = chatBox.scrollHeight;
                }
            }
        }

        // --- RENDER FUNCTIONS ---
        
        function renderApp() {
            const app = document.getElementById('app');
            if (!app) return;

            // Render the main structure
            app.innerHTML = `
                <div class="p-4 sm:p-6 bg-white shadow-xl rounded-xl">
                    ${renderHeader()}
                    ${renderNavigationView()}
                </div>
                ${renderMessageModal()}
                ${renderLoadingOverlay()}
            `;
            
            // Render the specific view content
            renderView();
            
            // Re-attach event listeners after full render
            document.querySelectorAll('.nav-link').forEach(link => {
                link.onclick = (e) => {
                    e.preventDefault();
                    navigate(e.currentTarget.getAttribute('data-view'));
                };
            });
            
            // Show user ID for debugging/sharing
            document.getElementById('user-id-display').innerText = `ID: ${userId || 'N/A'}`;
        }
        
        function renderView() {
            const content = document.getElementById('content-area');
            if (!content) return;
            
            switch (state.currentView) {
                case 'home':
                    content.innerHTML = renderHomeView();
                    break;
                case 'tasks':
                    content.innerHTML = renderTasksView();
                    break;
                case 'coach':
                    content.innerHTML = renderCoachView();
                    // Scroll to bottom after rendering chat
                    setTimeout(() => {
                        const chatBox = document.getElementById('chat-box');
                        if (chatBox) {
                            chatBox.scrollTop = chatBox.scrollHeight;
                        }
                    }, 50);
                    break;
                case 'progress':
                    content.innerHTML = renderProgressView();
                    break;
                case 'sleep':
                    content.innerHTML = renderSleepPlanView();
                    break;
                case 'library':
                    content.innerHTML = renderLibraryView();
                    break;
                case 'test':
                    content.innerHTML = renderTestView();
                    break;
                case 'settings':
                    content.innerHTML = renderSettingsView();
                    break;
                default:
                    content.innerHTML = renderHomeView();
            }

            // Re-attach view-specific listeners
            attachViewListeners();
        }
        
        function attachViewListeners() {
            if (state.currentView === 'tasks') {
                document.querySelectorAll('.task-toggle').forEach(btn => {
                    btn.onclick = (e) => updateTaskStatus(e.currentTarget.getAttribute('data-id'));
                });
            } else if (state.currentView === 'coach') {
                const input = document.getElementById('coach-input');
                const sendBtn = document.getElementById('coach-send-btn');
                if (sendBtn) sendBtn.onclick = handleCoachInteraction;
                if (input) input.onkeyup = (e) => { if (e.key === 'Enter') handleCoachInteraction(); };
            } else if (state.currentView === 'test') {
                document.getElementById('complete-test-btn').onclick = completeTest;
            } else if (state.currentView === 'settings') {
                document.querySelectorAll('.coach-select-btn').forEach(btn => {
                    btn.onclick = (e) => {
                        state.selectedCoach = e.currentTarget.getAttribute('data-coach');
                        saveState();
                        renderView();
                    };
                });
            } else if (state.currentView === 'progress') {
                document.querySelectorAll('.habit-check-input').forEach(input => {
                    input.onchange = (e) => {
                        const habitId = e.target.getAttribute('data-habit-id');
                        const dayIndex = parseInt(e.target.getAttribute('data-day-index'), 10);
                        const score = e.target.checked ? 1 : 0;
                        updateDailyHabitProgress(habitId, dayIndex, score);
                    };
                });
                document.querySelectorAll('.challenge-complete-btn').forEach(btn => {
                    btn.onclick = (e) => updateChallengeProgress(e.currentTarget.getAttribute('data-id'));
                });
            } else if (state.currentView === 'sleep') {
                 document.querySelectorAll('.sleep-toggle').forEach(btn => {
                    btn.onclick = (e) => {
                        const dayIndex = parseInt(e.currentTarget.getAttribute('data-day-index'), 10);
                        updateSleepPlanStatus(dayIndex);
                    };
                });
            }
        }
        
        // --- HTML Renderers ---

        function renderHeader() {
            const coachEmoji = COACHES[state.selectedCoach].emoji;
            return `
                <div class="flex flex-col sm:flex-row justify-between items-center pb-4 border-b border-indigo-100">
                    <h1 class="text-3xl font-extrabold text-gray-800 flex items-center mb-4 sm:mb-0">
                        ${coachEmoji} AI-–¢—Ä–µ–Ω–µ—Ä: ${COACHES[state.selectedCoach].name}
                    </h1>
                    <div class="text-xs text-gray-500 rounded-full bg-indigo-50 px-3 py-1" id="user-id-display"></div>
                </div>
            `;
        }

        function renderNavigationView() {
            const links = [
                { id: 'home', name: '–ì–ª–∞–≤–Ω–∞—è', icon: 'üè†' },
                { id: 'tasks', name: '–ó–∞–¥–∞—á–∏', icon: 'üìù' },
                { id: 'progress', name: '–ü—Ä–æ–≥—Ä–µ—Å—Å', icon: 'üìà' },
                { id: 'sleep', name: '–°–æ–Ω (28 –î–Ω–µ–π)', icon: 'üåô' }, // Updated name
                { id: 'coach', name: '–ß–∞—Ç —Å AI', icon: 'üí¨' },
                { id: 'library', name: '–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞', icon: 'üìö' },
                { id: 'settings', name: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏', icon: '‚öôÔ∏è' },
            ];

            return `
                <div class="pt-4 flex flex-wrap gap-2 justify-start sm:justify-center border-b pb-4 mb-6">
                    ${links.map(link => `
                        <a href="#" data-view="${link.id}" class="nav-link px-3 py-2 rounded-lg font-medium text-sm transition duration-150 ${state.currentView === link.id ? 'active' : 'text-indigo-600 hover:bg-indigo-50'}">
                            ${link.icon} ${link.name}
                        </a>
                    `).join('')}
                </div>
                <div id="content-area"></div>
            `;
        }

        function renderHomeView() {
            const percentage = state.progress.totalTasks > 0 ? Math.round((state.progress.completedTasks / state.progress.totalTasks) * 100) : 0;
            return `
                <div class="space-y-8">
                    <!-- Progress Card -->
                    <div class="bg-indigo-50 border-l-4 border-indigo-500 p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-semibold text-indigo-700 mb-4">–í–∞—à –û–±—â–∏–π –ü—Ä–æ–≥—Ä–µ—Å—Å</h2>
                        <div class="flex items-center space-x-4">
                            <div class="w-20 h-20 relative">
                                <svg class="w-full h-full transform -rotate-90">
                                    <circle class="text-gray-200" stroke-width="8" stroke="currentColor" fill="transparent" r="32" cx="40" cy="40"/>
                                    <circle class="text-indigo-500" stroke-width="8" stroke="currentColor" fill="transparent" r="32" cx="40" cy="40"
                                        style="stroke-dasharray: 201; stroke-dashoffset: ${201 - (percentage / 100) * 201}px; transition: stroke-dashoffset 0.5s ease;"/>
                                </svg>
                                <span class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-lg font-bold text-indigo-700">${percentage}%</span>
                            </div>
                            <div>
                                <p class="text-gray-600 font-medium">${state.progress.completedTasks} –∏–∑ ${state.progress.totalTasks || '0'} –∑–∞–¥–∞—á –≤—ã–ø–æ–ª–Ω–µ–Ω–æ.</p>
                                <p class="text-sm text-gray-500 mt-1">–ü—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ! üöÄ</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quote Card -->
                    <div class="bg-white p-6 rounded-lg shadow-md border-t-4 border-indigo-300">
                        <p class="text-xl italic text-gray-700 mb-2">¬´${APP_CONTENT.quote.text}¬ª</p>
                        <p class="text-sm font-medium text-indigo-500 text-right">‚Äî ${APP_CONTENT.quote.author}</p>
                    </div>

                    <!-- Next Tasks/Action -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">–¢–≤–æ–π –§–æ–∫—É—Å –Ω–∞ –°–µ–≥–æ–¥–Ω—è</h2>
                        ${state.tasks.length > 0 ? 
                            state.tasks.slice(0, 3).map(task => `
                                <div class="flex items-start p-3 bg-indigo-50 rounded-lg mb-2 border-l-4 border-indigo-400">
                                    <span class="text-lg mr-3 mt-0.5">üí°</span>
                                    <div>
                                        <p class="font-semibold text-gray-800">${task.name} <span class="text-xs font-normal text-indigo-500">(${task.sphere})</span></p>
                                        <p class="text-sm text-gray-600">${task.desc}</p>
                                    </div>
                                </div>
                            `).join('') :
                            `<p class="text-gray-500">–£ —Ç–µ–±—è –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á! –ü–æ–ø—Ä–æ—Å–∏ —Å–≤–æ–µ–≥–æ AI-—Ç—Ä–µ–Ω–µ—Ä–∞ ${COACHES[state.selectedCoach].name} (${COACHES[state.selectedCoach].emoji}) —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–µ, –∏–ª–∏ –ø—Ä–æ–π–¥–∏ —Ç–µ—Å—Ç.</p>`
                        }
                        <button onclick="navigate('tasks')" class="mt-4 w-full bg-indigo-500 text-white py-2 rounded-lg hover:bg-indigo-600 transition font-semibold">
                            –°–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –∑–∞–¥–∞—á–∏
                        </button>
                    </div>

                    <!-- Bonus Points Card -->
                    <div class="bg-yellow-50 border-l-4 border-yellow-500 p-6 rounded-lg shadow-md">
                         <h2 class="text-2xl font-semibold text-yellow-700 mb-2">–ë–æ–Ω—É—Å–Ω—ã–µ –û—á–∫–∏ üåü</h2>
                         <p class="text-3xl font-bold text-yellow-800">${state.bonusPoints}</p>
                         <p class="text-sm text-gray-600 mt-1">–í—ã –∑–∞—Ä–∞–±–æ—Ç–∞–ª–∏ –∏—Ö, —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–∞—è —à–∞–≥–∏ 28-–¥–Ω–µ–≤–Ω–æ–≥–æ –ø–ª–∞–Ω–∞ —Å–Ω–∞.</p>
                    </div>
                </div>
            `;
        }

        function renderTasksView() {
            const activeTasks = state.tasks;
            const archivedTasks = state.taskArchive;
            
            return `
                <div class="space-y-8">
                    <h2 class="text-2xl font-bold text-gray-800">–ê–∫—Ç–∏–≤–Ω—ã–µ –ó–∞–¥–∞—á–∏ (${activeTasks.length})</h2>
                    <div class="space-y-4">
                        ${activeTasks.length > 0 ? activeTasks.map(task => `
                            <div class="bg-white p-4 rounded-lg shadow-md flex items-start justify-between border-l-4 ${task.isPersonalized ? 'border-pink-500' : 'border-indigo-500'}">
                                <div class="flex-grow">
                                    <h3 class="font-bold text-lg text-gray-800">${task.name} <span class="text-sm font-medium text-gray-500">(${task.sphere})</span></h3>
                                    <p class="text-sm text-gray-600 mt-1">${task.desc}</p>
                                    <p class="text-xs text-green-600 mt-1">üî• –í—ã–≥–æ–¥–∞: ${task.benefit}</p>
                                </div>
                                <button data-id="${task.id}" class="task-toggle ml-4 p-2 rounded-full bg-green-100 text-green-600 hover:bg-green-200 transition" title="–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                                    </svg>
                                </button>
                            </div>
                        `).join('') : '<p class="text-gray-500">–£ —Ç–µ–±—è –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á. –ù–∞—á–Ω–∏ —á–∞—Ç —Å —Ç—Ä–µ–Ω–µ—Ä–æ–º!</p>'}
                    </div>

                    <h2 class="text-2xl font-bold text-gray-800 pt-8">–ê—Ä—Ö–∏–≤ –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –ó–∞–¥–∞—á (${archivedTasks.length})</h2>
                    <div class="space-y-4 opacity-70">
                         ${archivedTasks.length > 0 ? archivedTasks.map(task => `
                            <div class="bg-gray-100 p-4 rounded-lg shadow-inner flex items-start justify-between border-l-4 border-gray-400">
                                <div class="flex-grow">
                                    <h3 class="font-bold text-lg text-gray-600 line-through">${task.name}</h3>
                                    <p class="text-sm text-gray-500 mt-1">${task.desc}</p>
                                </div>
                                <button data-id="${task.id}" class="task-toggle ml-4 p-2 rounded-full bg-red-100 text-red-600 hover:bg-red-200 transition" title="–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å">
                                     <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                    </svg>
                                </button>
                            </div>
                        `).join('') : '<p class="text-gray-500">–ê—Ä—Ö–∏–≤ –ø—É—Å—Ç.</p>'}
                    </div>
                </div>
            `;
        }
        
        // UPDATED: Progress View with Chart Fix and Highlight
        function renderProgressView() {
            const dailyAverages = calculateDailyAverages(); // Reversed array (L-to-R)
            const todayIndex = HABIT_DAYS - 1; // Today is the last element after reverse
            
            return `
                <div class="space-y-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">–î–Ω–µ–≤–Ω–æ–π –¢—Ä–µ–∫–µ—Ä –ü—Ä–∏–≤—ã—á–µ–∫ (21 –î–µ–Ω—å)</h2>

                    <!-- Habit Chart (Left-to-Right) -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-indigo-100">
                        <h3 class="text-xl font-semibold mb-4 text-gray-700">–ü—Ä–æ—Ü–µ–Ω—Ç –í—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ü—Ä–∏–≤—ã—á–µ–∫ (–∑–∞ 21 –¥–µ–Ω—å)</h3>
                        <div class="flex items-end justify-center h-48 border-b border-gray-300 px-2 pb-2">
                            ${dailyAverages.map((day, index) => {
                                // Index 0 is the oldest day, index HABIT_DAYS-1 is today
                                const height = Math.max(10, day.average * 100); // Min height 10px
                                const isToday = index === todayIndex;
                                const dateLabel = isToday ? '–°–µ–≥–æ–¥–Ω—è' : `${HABIT_DAYS - index} –¥.`;
                                const barClass = day.allCompleted ? 'all-completed' : 'bg-indigo-500';

                                return `
                                    <div class="flex flex-col items-center group relative cursor-help" style="height: 100%;">
                                        <div class="chart-bar ${barClass}" style="height: ${height}%;" title="${dateLabel}: ${Math.round(day.average * 100)}%"></div>
                                        <span class="text-xs mt-1 text-gray-500 -rotate-45 transform origin-top-left">${dateLabel}</span>
                                        <!-- Tooltip -->
                                        <div class="absolute bottom-full mb-2 hidden group-hover:block px-3 py-1 bg-gray-800 text-white text-xs rounded-lg whitespace-nowrap">
                                            ${dateLabel} - ${Math.round(day.average * 100)}%
                                            ${day.allCompleted ? ' <span class="text-yellow-300">üéâ 100%</span>' : ''}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>


                    <!-- Habit Table -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-indigo-100 mt-8">
                         <h3 class="text-xl font-semibold mb-4 text-gray-700">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –û—Ç–º–µ—Ç–∫–∏</h3>
                         <div class="habit-table-container">
                            <table class="habit-table w-full text-sm rounded-lg border-collapse">
                                <thead class="bg-indigo-50 text-indigo-700 sticky top-0">
                                    <tr>
                                        <th class="text-left font-bold p-3">–ü—Ä–∏–≤—ã—á–∫–∞ / –¶–µ–ª—å</th>
                                        ${[...Array(HABIT_DAYS)].map((_, i) => `<th class="${i === 0 ? 'bg-indigo-200 text-indigo-800' : ''}">${HABIT_DAYS - i} –¥.</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${state.dailyHabits.map(habit => `
                                        <tr class="border-b border-gray-100 hover:bg-gray-50">
                                            <td class="text-left font-medium p-3 sticky-col">${habit.name} <span class="text-xs text-gray-500">(${habit.target})</span></td>
                                            ${habit.progress.map((score, dayIndex) => `
                                                <td class="${dayIndex === 0 ? 'bg-indigo-100' : ''}">
                                                    <input type="checkbox" 
                                                           class="habit-check-input h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                                                           data-habit-id="${habit.id}" 
                                                           data-day-index="${dayIndex}"
                                                           ${score === 1 ? 'checked' : ''}
                                                           title="${HABIT_DAYS - dayIndex} –¥–µ–Ω—å: ${score === 1 ? '–í—ã–ø–æ–ª–Ω–µ–Ω–æ' : '–ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ'}"
                                                    />
                                                </td>
                                            `).join('')}
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                         </div>
                    </div>

                    <!-- Challenges Section (No Change) -->
                    <h2 class="text-2xl font-bold text-gray-800 pt-8">–ß–µ–ª–ª–µ–Ω–¥–∂–∏ (${state.challenges.filter(c => !c.completed).length})</h2>
                    <div class="space-y-4">
                        ${state.challenges.map(challenge => `
                            <div class="bg-white p-4 rounded-lg shadow-md flex items-center justify-between border-l-4 ${challenge.completed ? 'border-green-500 bg-green-50' : 'border-red-500'}">
                                <div class="flex-grow">
                                    <h3 class="font-bold text-lg text-gray-800">${challenge.name} (${challenge.days} –¥–Ω–µ–π)</h3>
                                    <p class="text-sm text-gray-600 mt-1">${challenge.desc}</p>
                                    <p class="text-xs text-indigo-600 mt-1">–ü—Ä–æ–≥—Ä–µ—Å—Å: ${challenge.progress} / ${challenge.target} –¥–Ω–µ–π</p>
                                    <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                                        <div class="h-2.5 rounded-full ${challenge.completed ? 'bg-green-500' : 'bg-red-500'}" style="width: ${Math.min(100, (challenge.progress / challenge.target) * 100)}%"></div>
                                    </div>
                                </div>
                                ${!challenge.completed ? `
                                    <button data-id="${challenge.id}" class="challenge-complete-btn ml-4 p-2 rounded-full bg-indigo-100 text-indigo-600 hover:bg-indigo-200 transition" title="–û—Ç–º–µ—Ç–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞ –¥–µ–Ω—å">
                                        +1 –î–µ–Ω—å
                                    </button>
                                ` : `<span class="ml-4 text-green-600 font-bold">–ó–ê–í–ï–†–®–ï–ù–û!</span>`}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // NEW/UPDATED: Sleep Plan View with 28 days and Gamification
        function renderSleepPlanView() {
            return `
                <div class="space-y-8">
                    <div class="bg-indigo-50 border-l-4 border-indigo-500 p-6 rounded-lg shadow-md">
                         <h2 class="text-3xl font-bold text-indigo-700 mb-2">28 –î–Ω–µ–π –ó–¥–æ—Ä–æ–≤–æ–≥–æ –°–Ω–∞ üåô</h2>
                         <p class="text-xl font-bold text-gray-800">–ë–æ–Ω—É—Å–Ω—ã–µ –û—á–∫–∏: <span class="text-yellow-600">${state.bonusPoints}</span> üåü</p>
                         <p class="text-sm text-gray-600 mt-2">–ü—Ä–æ–π–¥–∏ –≤—Å–µ 28 —à–∞–≥–æ–≤, —á—Ç–æ–±—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Å—Ç—Ä–æ–∏—Ç—å —Å–≤–æ–π —Ä–µ–∂–∏–º. –ó–∞ –∫–∞–∂–¥—ã–π —à–∞–≥ —Ç—ã –ø–æ–ª—É—á–∞–µ—à—å –±–æ–Ω—É—Å–Ω—ã–µ –æ—á–∫–∏!</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${state.sleepPlan.map((plan, index) => `
                            <div class="bg-white p-4 rounded-xl shadow-lg border-l-4 transition duration-300 ${plan.completed ? 'border-green-500 bg-green-50' : 'border-red-500 hover:shadow-xl'}">
                                <div class="flex items-center justify-between mb-2">
                                    <h3 class="font-bold text-xl ${plan.completed ? 'text-green-700' : 'text-gray-800'}">
                                        –î–µ–Ω—å ${plan.day}
                                    </h3>
                                    <span class="text-sm font-semibold text-yellow-600 bg-yellow-100 px-2 py-0.5 rounded-full">+${plan.bonusPoints} –û–ß–ö–û–í</span>
                                </div>
                                
                                <p class="text-md font-medium ${plan.completed ? 'line-through text-gray-500' : 'text-gray-800'}">${plan.recommendation}</p>
                                <p class="text-xs text-gray-600 mt-2 italic bg-gray-50 p-2 rounded">${plan.explanation}</p>

                                <div class="mt-4 flex justify-end">
                                     <button data-day-index="${index}" class="sleep-toggle px-3 py-1 text-sm rounded-full transition duration-150 
                                        ${plan.completed ? 'bg-green-500 text-white hover:bg-green-600' : 'bg-red-100 text-red-600 hover:bg-red-200'}">
                                        ${plan.completed ? '–í—ã–ø–æ–ª–Ω–µ–Ω–æ ‚úÖ' : '–û—Ç–º–µ—Ç–∏—Ç—å ‚è≥'}
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // UPDATED: Library View with new content
        function renderLibraryView() {
            const library = APP_CONTENT.library;
            return `
                <div class="space-y-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ú–æ—Ç–∏–≤–∞—Ü–∏–∏ –∏ –ó–Ω–∞–Ω–∏–π üìö</h2>
                    <p class="text-gray-600">–ü–æ–¥–±–æ—Ä–∫–∞ –∫–Ω–∏–≥ –ø–æ –ø—Å–∏—Ö–æ–ª–æ–≥–∏–∏ –∏ –∏—Å—Ç–æ—Ä–∏–π —É—Å–ø–µ—Ö–∞ –∏–∑ –±–∏–∑–Ω–µ—Å–∞ –∏ —Å–ø–æ—Ä—Ç–∞, —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–≤–æ–µ–≥–æ —Ä–∞–∑–≤–∏—Ç–∏—è.</p>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        ${library.map(item => `
                            <div class="bg-white p-5 rounded-xl shadow-lg border-t-4 border-indigo-400 hover:shadow-xl transition duration-300">
                                <h3 class="text-xl font-bold text-gray-800">${item.title}</h3>
                                <p class="text-sm text-indigo-600 mb-2">–ê–≤—Ç–æ—Ä/–°—Ñ–µ—Ä–∞: ${item.author}</p>
                                <div class="flex flex-wrap gap-1 mb-3">
                                    ${item.spheres.map(s => `<span class="text-xs font-medium bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded-full">${s}</span>`).join('')}
                                </div>
                                <p class="text-gray-600 text-sm">${item.desc}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderCoachView() {
            const coach = COACHES[state.selectedCoach];
            return `
                <div class="flex flex-col h-[70vh] bg-white rounded-xl shadow-lg">
                    <!-- Chat Header -->
                    <div class="p-4 bg-indigo-100 rounded-t-xl border-b border-indigo-200">
                        <h3 class="text-xl font-semibold text-indigo-700">${coach.emoji} –ß–∞—Ç —Å ${coach.name} (${coach.style})</h3>
                        <p class="text-sm text-indigo-500">–°–ø—Ä–∞—à–∏–≤–∞–π, —á—Ç–æ –¥–µ–ª–∞—Ç—å, –∏–ª–∏ –ø—Ä–æ—Å–∏ –æ –Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á–∞—Ö!</p>
                    </div>

                    <!-- Chat Body -->
                    <div id="chat-box" class="flex-grow p-4 overflow-y-auto chat-box space-y-4 relative">
                        ${state.coachChat.map(msg => `
                            <div class="flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}">
                                <div class="max-w-xs sm:max-w-md p-3 rounded-xl shadow-md ${
                                    msg.role === 'user' 
                                    ? 'bg-indigo-500 text-white rounded-br-none' 
                                    : 'bg-gray-100 text-gray-800 rounded-tl-none'
                                }">
                                    <p class="text-sm whitespace-pre-wrap">${msg.message}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    ${isLoading ? `
                        <div class="flex justify-start items-center p-4">
                            <div class="spinner w-6 h-6 border-indigo-500 border-t-indigo-200 mr-3"></div>
                            <p class="text-sm text-gray-500"> ${coach.name} –¥—É–º–∞–µ—Ç...</p>
                        </div>
                    ` : ''}

                    <!-- Chat Input -->
                    <div class="p-4 border-t border-gray-200 flex space-x-3 bg-gray-50 rounded-b-xl">
                        <input type="text" id="coach-input" placeholder="–°–ø—Ä–æ—Å–∏ —É ${coach.name}..." class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" ${isLoading ? 'disabled' : ''}>
                        <button id="coach-send-btn" class="bg-indigo-500 text-white p-3 rounded-lg hover:bg-indigo-600 transition disabled:opacity-50" ${isLoading ? 'disabled' : ''}>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transform rotate-90" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                            </svg>
                        </button>
                    </div>
                </div>
            `;
        }

        function renderTestView() {
            if (state.isPersonalized) {
                return `
                    <div class="bg-green-100 border-l-4 border-green-500 p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-bold text-green-700">–¢–µ—Å—Ç –ó–∞–≤–µ—Ä—à–µ–Ω! ‚úÖ</h2>
                        <p class="text-gray-600 mt-2">–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å —É–∂–µ —Å–æ–∑–¥–∞–Ω, –∏ –≤—ã –º–æ–∂–µ—Ç–µ –æ–±—â–∞—Ç—å—Å—è —Å AI-—Ç—Ä–µ–Ω–µ—Ä–æ–º.</p>
                        <p class="text-sm text-gray-500 mt-1">–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ <a href="#" onclick="navigate('coach')" class="text-green-600 font-medium hover:underline">–ß–∞—Ç —Å AI</a>.</p>
                        <div class="mt-4 p-3 bg-white rounded-lg">
                            <p class="font-semibold text-gray-800">–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å:</p>
                            ${Object.entries(state.testResults).map(([key, value]) => `<p class="text-sm">${key}: ${value}/4</p>`).join('')}
                        </div>
                    </div>
                `;
            }
            
            return `
                <div class="space-y-6">
                    <div class="bg-yellow-100 border-l-4 border-yellow-500 p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-bold text-yellow-700">–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è: –≠–∫—Å–ø—Ä–µ—Å—Å-–¢–µ—Å—Ç</h2>
                        <p class="text-gray-600 mt-2">–û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ 4 –≤–æ–ø—Ä–æ—Å–∞, —á—Ç–æ–±—ã –≤–∞—à AI-—Ç—Ä–µ–Ω–µ—Ä –º–æ–≥ –¥–∞—Ç—å –≤–∞–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–ª–µ–∑–Ω—ã–µ –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–≤–µ—Ç—ã –∏ –∑–∞–¥–∞—á–∏.</p>
                    </div>
                    
                    ${TEST_QUESTIONS.map(q => `
                        <div class="bg-white p-5 rounded-lg shadow-md border-t-2 border-gray-200">
                            <h3 class="font-bold text-lg text-gray-800 mb-3">${q.id}. ${q.question}</h3>
                            <div class="flex flex-col space-y-2">
                                ${q.options.map((option, index) => {
                                    const value = index + 1;
                                    const isSelected = state.testAnswers[q.id] === value;
                                    return `
                                        <label class="flex items-center cursor-pointer p-3 rounded-lg border transition duration-150 
                                            ${isSelected ? 'bg-indigo-50 border-indigo-500 shadow-sm' : 'bg-gray-50 border-gray-200 hover:bg-gray-100'}">
                                            <input type="radio" name="${q.id}" value="${value}" 
                                                   onchange="handleTestAnswer('${q.id}', ${index})"
                                                   class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500" ${isSelected ? 'checked' : ''}>
                                            <span class="ml-3 text-gray-700">${option}</span>
                                        </label>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `).join('')}
                    
                    <button id="complete-test-btn" class="w-full bg-green-500 text-white py-3 rounded-lg text-xl font-bold hover:bg-green-600 transition">
                        –ó–∞–≤–µ—Ä—à–∏—Ç—å –¢–µ—Å—Ç –∏ –í—ã–±—Ä–∞—Ç—å –¢—Ä–µ–Ω–µ—Ä–∞
                    </button>
                </div>
            `;
        }

        function renderSettingsView() {
            const coaches = Object.entries(COACHES);
            return `
                <div class="space-y-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ AI-–¢—Ä–µ–Ω–µ—Ä–∞</h2>

                    <!-- Coach Selection -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-indigo-100">
                        <h3 class="text-xl font-semibold mb-4 text-gray-700">–í—ã–±–æ—Ä –°—Ç–∏–ª—è –ö–æ—É—á–∞</h3>
                        <p class="text-sm text-gray-500 mb-4">–í—ã–±–µ—Ä–∏, –∫–∞–∫–æ–π –ø–æ–¥—Ö–æ–¥ –∫ –º–æ—Ç–∏–≤–∞—Ü–∏–∏ —Ç–µ–±–µ –±–ª–∏–∂–µ:</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            ${coaches.map(([key, coach]) => `
                                <button data-coach="${key}" class="coach-select-btn p-4 rounded-xl text-left border-2 transition duration-200 ${
                                    state.selectedCoach === key 
                                    ? 'border-indigo-500 bg-indigo-50 shadow-md scale-105' 
                                    : 'border-gray-200 hover:bg-gray-50'
                                }">
                                    <div class="text-3xl mb-2">${coach.emoji}</div>
                                    <h4 class="font-bold text-lg text-gray-800">${coach.name}</h4>
                                    <p class="text-sm text-gray-600">${coach.style}</p>
                                    ${state.selectedCoach === key ? '<span class="text-xs text-indigo-500 font-semibold mt-1 block">–ê–∫—Ç–∏–≤–µ–Ω</span>' : ''}
                                </button>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Test Results -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                        <h3 class="text-xl font-semibold mb-4 text-gray-700">–ü—Ä–æ—Ñ–∏–ª—å –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¢–µ—Å—Ç–∞)</h3>
                        <div class="space-y-2">
                            ${state.isPersonalized ? Object.entries(state.testResults).map(([key, value]) => `
                                <div class="flex justify-between items-center py-1 border-b border-gray-100">
                                    <span class="font-medium text-gray-600">${key.charAt(0).toUpperCase() + key.slice(1)}:</span>
                                    <span class="font-bold text-lg text-indigo-600">${value} / 4</span>
                                </div>
                            `).join('') : '<p class="text-red-500">–ü—Ä–æ–π–¥–∏—Ç–µ —Ç–µ—Å—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è!</p>'}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMessageModal() {
            return `
                <div id="message-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform transition-all scale-100">
                        <h3 id="modal-title" class="text-2xl font-bold text-gray-800 mb-3"></h3>
                        <p id="modal-message" class="text-gray-600 mb-6"></p>
                        <button onclick="hideMessage()" class="w-full bg-indigo-500 text-white py-2 rounded-lg hover:bg-indigo-600 transition font-semibold">
                            –ü–æ–Ω—è—Ç–Ω–æ
                        </button>
                    </div>
                </div>
            `;
        }

        function renderLoadingOverlay() {
            // This is primarily for the *initial* Firebase loading state, 
            // but the API loading is handled within the coach view.
            if (!isAuthReady) {
                return `
                    <div class="loading-overlay">
                        <div class="flex flex-col items-center">
                            <div class="spinner"></div>
                            <p class="mt-4 text-indigo-600 font-medium">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
                        </div>
                    </div>
                `;
            }
            return '';
        }

        window.onload = function() {
            // Initial call to start the app lifecycle (handled by onAuthStateChanged/initial checks)
            // If Firebase is not configured, it runs initLocalState and renderApp directly.
            if (!db) {
                renderApp();
            }
        };

        // Expose necessary functions globally for use in inline event handlers
        window.navigate = navigate;
        window.handleTestAnswer = handleTestAnswer;
        window.updateTaskStatus = updateTaskStatus;
        window.hideMessage = hideMessage;
        window.updateSleepPlanStatus = updateSleepPlanStatus; 
        
    </script>
</head>
<body class="p-4 sm:p-8">
    <div id="app" class="app-container">
        <!-- Application content will be rendered here by renderApp() -->
    </div>
</body>
</html>
